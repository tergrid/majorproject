/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as o}from"../../chunks/tslib.es6.js";import t from"../../core/Accessor.js";import r from"../../core/Error.js";import{JSONSupportMixin as e}from"../../core/JSONSupport.js";import n from"../../core/Logger.js";import{transformProjective as i,getProjectiveTransform as s}from"../../core/perspectiveUtils.js";import{createScreenPoint as l}from"../../core/screenUtils.js";import{property as c}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/RandomLCG.js";import{reader as a}from"../../core/accessorSupport/decorators/reader.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import{writer as u}from"../../core/accessorSupport/decorators/writer.js";import{invert as m}from"../../core/libs/gl-matrix-2/math/mat3.js";import{fromValues as f,create as P}from"../../core/libs/gl-matrix-2/factories/mat3f64.js";import{set as h,rotate as d,lerp as y}from"../../core/libs/gl-matrix-2/math/vec2.js";import{create as g,fromValues as j}from"../../core/libs/gl-matrix-2/factories/vec2f64.js";import w from"../../geometry/Point.js";import x from"../../geometry/Polygon.js";import{projectOrLoad as v}from"../../geometry/projection.js";import R from"../../geometry/SpatialReference.js";import S from"./GeoreferenceBase.js";const C=P(),b=g();let _=class extends t{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};o([c()],_.prototype,"sourcePoint",void 0),o([c({type:w})],_.prototype,"mapPoint",void 0),_=o([p("esri.layers.support.ControlPoint")],_);let T=class extends(e(S)){constructor(o){super(o),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(o,t){const r=R.fromJSON(t.spatialReference),e=f(...t.coefficients,1);return o.map((o=>(h(b,o.x,o.y),i(b,b,e),{sourcePoint:o,mapPoint:new w({x:b[0],y:b[1],spatialReference:r})})))}writeControlPoints(o,t,e,i){if(null!=this.transform)null!=o&&O(o[0])&&(t.controlPoints=o.map((o=>{const t=o.sourcePoint;return{x:t.x,y:t.y}})),t.spatialReference=o[0].mapPoint.spatialReference.toJSON(),t.coefficients=this.transform.slice(0,8));else{const o=new r("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:i?.layer,georeference:this});i?.messages?i.messages.push(o):n.getLogger(this).error(o.name,o.message)}}get coords(){if(null==this.controlPoints)return null;const o=this._updateTransform(C);if(null==o||!O(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return H(o,this.width,this.height,t)}set coords(o){if(null==this.controlPoints||!O(this.controlPoints[0]))return;const t=this.controlPoints[0].mapPoint.spatialReference;if(null==(o=this.projectOrWarn(o,t)))return;const{width:r,height:e}=this,{rings:[[n,s,c,a]]}=o,p={sourcePoint:l(0,e),mapPoint:new w({x:n[0],y:n[1],spatialReference:t})},u={sourcePoint:l(0,0),mapPoint:new w({x:s[0],y:s[1],spatialReference:t})},m={sourcePoint:l(r,0),mapPoint:new w({x:c[0],y:c[1],spatialReference:t})},f={sourcePoint:l(r,e),mapPoint:new w({x:a[0],y:a[1],spatialReference:t})};O(p)&&O(u)&&O(m)&&O(f)&&(E(C,p,u,m,f),this.controlPoints=this.controlPoints.map((({sourcePoint:o})=>(h(b,o.x,o.y),i(b,b,C),{sourcePoint:o,mapPoint:new w({x:b[0],y:b[1],spatialReference:t})}))))}get inverseTransform(){return null==this.transform?null:m(P(),this.transform)}get transform(){return this._updateTransform()}toMap(o){if(null==o||null==this.transform||null==this.controlPoints||!O(this.controlPoints[0]))return null;h(b,o.x,o.y);const t=this.controlPoints[0].mapPoint.spatialReference;return i(b,b,this.transform),new w({x:b[0],y:b[1],spatialReference:t})}toSource(o){if(null==o||null==this.inverseTransform||null==this.controlPoints||!O(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return o=o.normalize(),null==(o=v(o,t).geometry)?null:(h(b,o.x,o.y),i(b,b,this.inverseTransform),l(b[0],b[1]))}toSourceNormalized(o){const t=this.toSource(o);return null!=t&&(t.x/=this.width,t.y/=this.height),t}_updateTransform(o){const{controlPoints:t,width:r,height:e}=this;if(!(null!=t&&r>0&&e>0))return null;const[n,i,s,l]=t;if(!O(n))return null;const c=n.mapPoint.spatialReference,a=this._projectControlPoint(i,c),p=this._projectControlPoint(s,c),u=this._projectControlPoint(l,c);if(!a.valid||!p.valid||!u.valid)return null;if(!O(a.controlPoint))return null;null==o&&(o=P());let m=null;return m=O(p.controlPoint)&&O(u.controlPoint)?E(o,n,a.controlPoint,p.controlPoint,u.controlPoint):O(p.controlPoint)?B(o,n,a.controlPoint,p.controlPoint):q(o,n,a.controlPoint),m.every((o=>0===o))?null:m}_projectControlPoint(o,t){if(!O(o))return{valid:!0,controlPoint:o};const{sourcePoint:r,mapPoint:e}=o,{geometry:i,pending:s}=v(e,t);return s?{valid:!1,controlPoint:null}:s||i?{valid:!0,controlPoint:{sourcePoint:r,mapPoint:i}}:(n.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:o,sourceSpatialReference:e.spatialReference,targetSpatialReference:t}),{valid:!1,controlPoint:null})}};function O(o){return null!=o?.sourcePoint&&null!=o.mapPoint}o([c({type:[_],json:{write:{allowNull:!1,isRequired:!0}}})],T.prototype,"controlPoints",void 0),o([a("controlPoints")],T.prototype,"readControlPoints",null),o([u("controlPoints")],T.prototype,"writeControlPoints",null),o([c()],T.prototype,"coords",null),o([c({json:{write:!0}})],T.prototype,"height",void 0),o([c({readOnly:!0})],T.prototype,"inverseTransform",null),o([c({readOnly:!0})],T.prototype,"transform",null),o([c({json:{write:!0}})],T.prototype,"width",void 0),T=o([p("esri.layers.support.ControlPointsGeoreference")],T);const N=g(),I=g(),L=g(),M=g(),A=g(),G=g(),J=g(),z=g(),U=Math.PI/2;function k(o,t,r){h(o,r.sourcePoint.x,r.sourcePoint.y),h(t,r.mapPoint.x,r.mapPoint.y)}function q(o,t,r){return k(N,A,t),k(I,G,r),d(L,I,N,U),d(M,N,I,U),d(J,G,A,-U),d(z,A,G,-U),F(o,N,I,L,M,A,G,J,z)}function B(o,t,r,e){return k(N,A,t),k(I,G,r),k(L,J,e),y(M,N,I,.5),d(M,L,M,Math.PI),y(z,A,G,.5),d(z,J,z,Math.PI),F(o,N,I,L,M,A,G,J,z)}function E(o,t,r,e,n){return k(N,A,t),k(I,G,r),k(L,J,e),k(M,z,n),F(o,N,I,L,M,A,G,J,z)}const V=new Array(8).fill(0),W=new Array(8).fill(0);function D(o,t,r,e,n){return o[0]=t[0],o[1]=t[1],o[2]=r[0],o[3]=r[1],o[4]=e[0],o[5]=e[1],o[6]=n[0],o[7]=n[1],o}function F(o,t,r,e,n,i,l,c,a){return s(o,D(V,t,r,e,n),D(W,i,l,c,a))}function H(o,t,r,e){const n=j(0,r),s=j(0,0),l=j(t,0),c=j(t,r);return i(n,n,o),i(s,s,o),i(l,l,o),i(c,c,o),new x({rings:[[n,s,l,c,n]],spatialReference:e})}const K=T;export{K as default};
