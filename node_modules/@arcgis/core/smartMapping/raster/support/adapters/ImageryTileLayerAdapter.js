/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import e from"../../../../core/Error.js";import{property as r}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import s from"../../../../geometry/Extent.js";import{estimateStatisticsHistograms as o}from"../../../../layers/support/rasterFunctions/stretchUtils.js";import i from"./RasterLayerAdapter.js";let n=class extends i{async generateRasterInfo(t){const{layer:e}=this,r=t?.rasterFunction;if("imagery-tile"===e.type&&r)try{return e.generateRasterInfo(r,{signal:t?.signal})}catch{return e.serviceRasterInfo}return this.rasterInfo}async estimateStatisticsHistograms(t){const{layer:r}=this,a=r.multidimensionalDefinition?.[0]?.variableName??"",s=`${r.rasterFunction?.functionName??"default"}${a}`,i=this._statsCache.get(s);if(i)return i;const{raster:n}=r,{extent:m,width:l,height:c}=this._getSamplePixelBlockDescriptor(n.rasterInfo),{pixelBlock:h}=await r.fetchPixels(m,l,c,t);if(null==h)throw new e("raster-layer-adapter","Unable to estimate histograms");const p=o(h);return p&&this._statsCache.put(s,p),p}supportsMultidirectionalHillshade(){return!0}load(t){return this.addResolvingPromise(this.layer.load(t).then((()=>this.rasterInfo=this.layer.raster.rasterInfo))),Promise.resolve(this)}_getSamplePixelBlockDescriptor(t,e=1e3){const{pyramidScalingFactor:r,maximumPyramidLevel:a}=t.storageInfo;let{extent:o,width:i,height:n,pixelSize:m}=t,l=Math.ceil(Math.log(Math.max(i,n)/e)/Math.log(r))-1,c=0,h=0;if(l<=a){const t=r**l;i=Math.floor(i/t),n=Math.floor(n/t)}else l=0,i=Math.min(i,e),n=Math.min(n,e),c=Math.max(Math.floor(i/2-500),0),h=Math.max(Math.floor(n/2-500),0),o=new s({xmin:o.xmin+c*m.x,xmax:Math.min(o.xmax,o.xmin+c*m.x*e),ymin:o.ymin+h*m.y,ymax:Math.min(o.ymax,o.ymin+h*m.y*e)});return{extent:o,width:i,height:n,origin:{x:c,y:h}}}};t([r()],n.prototype,"layer",void 0),n=t([a("esri.smartMapping.support.adapters.ImageryTileLayerAdapter")],n);const m=n;export{m as default};
