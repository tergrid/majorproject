/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../../../../core/Error.js";import t from"../../../../core/Logger.js";import{e as r}from"../../../../chunks/earcut.js";import{set as o}from"../../../../core/libs/gl-matrix-2/math/vec2.js";import{create as n}from"../../../../core/libs/gl-matrix-2/factories/vec2f64.js";import{convertFromNestedArray as s,convertFromPolygon as i}from"../../../../layers/graphics/featureConversionUtils.js";import c from"../../../../layers/graphics/OptimizedGeometry.js";import{i1616to32 as a}from"./number.js";import{BufferObject as f}from"../../../webgl/BufferObject.js";import{PrimitiveType as h,Usage as m,DataType as u}from"../../../webgl/enums.js";const l=t=>{switch(t.BYTES_PER_ELEMENT){case 1:return u.UNSIGNED_BYTE;case 2:return u.UNSIGNED_SHORT;case 4:return u.UNSIGNED_INT;default:throw new e("Cannot get DataType of array")}},y=(e,t,r,o)=>{let n=0;for(let s=1;s<r;s++){const r=e[2*(t+s-1)],o=e[2*(t+s-1)+1];n+=(e[2*(t+s)]-r)*(e[2*(t+s)+1]+o)}return o?n>0:n<0},x=({coords:e,lengths:t},o)=>{const n=[];for(let s=0,i=0;s<t.length;i+=t[s],s+=1){const c=i,a=[];for(;s<t.length-1&&y(e,i+t[s],t[s+1],o);s+=1,i+=t[s])a.push(i+t[s]-c);const f=e.slice(2*c,2*(i+t[s])),h=r(f,a,2);for(const e of h)n.push(e+c)}return n};class g{constructor(e,t,r,o=!1){this._cache={},this.vertices=e,this.indices=t,this.primitiveType=r,this.isMapSpace=o}static fromRect({x:e,y:t,width:r,height:o}){const n=e,s=t,i=n+r,c=s+o;return g.fromScreenExtent({xmin:n,ymin:s,xmax:i,ymax:c})}static fromPath(e){const t=s(new c,e.path,!1,!1),r=t.coords,o=new Uint32Array(x(t,!0)),n=new Uint32Array(r.length/2);for(let s=0;s<n.length;s++)n[s]=a(Math.floor(r[2*s]),Math.floor(r[2*s+1]));return new g({geometry:n},o,h.TRIANGLES)}static fromGeometry(r,o){const n=o.geometry?.type;switch(n){case"polygon":return g.fromPolygon(r,o.geometry);case"extent":return g.fromMapExtent(r,o.geometry);default:return t.getLogger("esri.views.2d.engine.webgl.Mesh2D").error(new e("mapview-bad-type",`Unable to create a mesh from type ${n}`,o)),g.fromRect({x:0,y:0,width:1,height:1})}}static fromPolygon(e,t){const r=i(new c,t,!1,!1),s=r.coords,f=new Uint32Array(x(r,!1)),m=new Uint32Array(s.length/2),u=n(),l=n();for(let n=0;n<m.length;n++)o(u,s[2*n],s[2*n+1]),e.toScreen(l,u),m[n]=a(Math.floor(l[0]),Math.floor(l[1]));return new g({geometry:m},f,h.TRIANGLES,!0)}static fromScreenExtent({xmin:e,xmax:t,ymin:r,ymax:o}){const n={geometry:new Uint32Array([a(e,r),a(t,r),a(e,o),a(e,o),a(t,r),a(t,o)])},s=new Uint32Array([0,1,2,3,4,5]);return new g(n,s,h.TRIANGLES)}static fromMapExtent(e,t){const[r,o]=e.toScreen([0,0],[t.xmin,t.ymin]),[n,s]=e.toScreen([0,0],[t.xmax,t.ymax]),i={geometry:new Uint32Array([a(r,o),a(n,o),a(r,s),a(r,s),a(n,o),a(n,s)])},c=new Uint32Array([0,1,2,3,4,5]);return new g(i,c,h.TRIANGLES)}destroy(){null!=this._cache.indexBuffer&&this._cache.indexBuffer.dispose();for(const e in this._cache.vertexBuffers)null!=this._cache.vertexBuffers[e]&&this._cache.vertexBuffers[e].dispose()}get elementType(){return l(this.indices)}getIndexBuffer(e,t=m.STATIC_DRAW){return this._cache.indexBuffer||(this._cache.indexBuffer=f.createIndex(e,t,this.indices)),this._cache.indexBuffer}getVertexBuffers(e,t=m.STATIC_DRAW){return this._cache.vertexBuffers||(this._cache.vertexBuffers=Object.keys(this.vertices).reduce(((r,o)=>({...r,[o]:f.createVertex(e,t,this.vertices[o])})),{})),this._cache.vertexBuffers}}export{g as default};
