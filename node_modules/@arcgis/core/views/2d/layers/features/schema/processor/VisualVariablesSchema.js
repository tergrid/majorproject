/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{pt2px as e}from"../../../../../../core/screenUtils.js";import{getMetersPerUnitForSR as a}from"../../../../../../core/unitUtils.js";import{meterIn as i}from"../../../../../../renderers/support/lengthUtils.js";import{nanMagicNumber as s}from"../../../../engine/webgl/definitions.js";import{RotationType as l}from"../../../../engine/webgl/shaderGraph/techniques/shaders/constants.js";import{padStops as t,premultiplyColor as r}from"./schemaUtils.js";import{simplifyVisualVariables as n}from"../../support/rendererUtils.js";const u=1.25,o=128,p=128;function c(e){if(!e.stops?.length)return null;const a=e.stops.sort(((e,a)=>e.value-a.value)),i=t(a,8),s=i.map((({value:e})=>e)),l=i.map((({color:e})=>r(e)));return{values:s,colors:l}}function v(e){if(!e.stops?.length)return null;const a=e.stops.sort(((e,a)=>e.value-a.value)),i=t(a,8);return{opacityValues:i.map((({value:e})=>e)),opacities:i.map((({opacity:e})=>e))}}function V(e){return{rotationType:"geographic"===e.rotationType?l.Geographic:l.Arithmatic}}function f(a){if(!a.stops?.length)return null;if(a.stops.some((e=>e.useMaxValue||e.useMinValue)))return(i,l)=>{const r=i.statisticsByLevel.get(l.key.level),n=a.stops.map((i=>({value:i.useMaxValue?r?.get(a.field)?.maxValue??0:i.useMinValue?r?.get(a.field)?.minValue??0:i.value,size:i.size?e(i.size):s}))).sort(((e,a)=>e.value-a.value)),u=t(n,8);return{values:u.map((({value:e})=>e)),sizes:u.map((({size:e})=>e))}};const i=a.stops.sort(((e,a)=>e.value-a.value)),l=t(i,8);return{values:l.map((({value:e})=>e)),sizes:l.map((({size:a})=>e(a)))}}function m(a){if(!a.stops?.length)return null;const i=a.stops.sort(((e,a)=>e.value-a.value)),s=t(i,8);return{values:s.map((({value:e})=>e)),sizes:s.map((({size:a})=>e(a)))}}function S(e){return s=>{const{state:l}=s;return{unitValueToPixelsRatio:a(l.spatialReference)/i[e.valueUnit]/l.resolution}}}function b(e,a){const i=a.length;if(e<a[0].value||1===i)return a[0].size;for(let s=1;s<i;s++)if(e<a[s].value){const i=(e-a[s-1].value)/(a[s].value-a[s-1].value);return a[s-1].size+i*(a[s].size-a[s-1].size)}return a[i-1].size}function z(a){const{minDataValue:i,maxDataValue:s,minSize:l,maxSize:t}=a;if("object"==typeof l&&"object"==typeof t)return(a,r)=>{const n=a.state.scale,u=e(b(n,l.stops)),o=e(b(n,t.stops));return{minMaxValueAndSize:[i,s,u,o]}};if("object"==typeof l||"object"==typeof t)throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[i,s,e(l),e(t)]}}const x={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function h(e,a=p,i=u){if(e.visualVariableSizeMinMaxValue)return e.visualVariableSizeMinMaxValue instanceof Function?o:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,a);if(e.visualVariableSizeScaleStops){if(e.visualVariableSizeScaleStops instanceof Function)return o;const s=e.visualVariableSizeScaleStops.sizes;return Math.max(s[s.length-1]*i,a)}if(e.visualVariableSizeStops){if(e.visualVariableSizeStops instanceof Function)return o;const s=e.visualVariableSizeStops.sizes;return Math.max(s[s.length-1]*i,a)}return e.visualVariableSizeUnitValue?2*o:0}function y(e){const a={...x};if(!e||!("visualVariables"in e)||!e.visualVariables)return a;for(const i of n(e.visualVariables))switch(i.type){case"color":a.visualVariableColor=c(i);break;case"opacity":a.visualVariableOpacity=v(i);break;case"rotation":a.visualVariableRotation=V(i);break;case"size":switch(M(i)){case"field-stops":a.visualVariableSizeStops=f(i);break;case"scale-stops":"outline"===i.target?a.visualVariableSizeOutlineScaleStops=f(i):a.visualVariableSizeScaleStops=f(i);break;case"min-max":a.visualVariableSizeMinMaxValue=z(i);break;case"unit-value":a.visualVariableSizeUnitValue=S(i)}break;default:console.error("Unable to handle VV type")}return a}function M(e){if("number"==typeof e.minDataValue&&"number"==typeof e.maxDataValue&&null!=e.minSize&&null!=e.maxSize)return"min-max";if((e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops))return"scale-stops";if((null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels))return"field-stops";if((null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit)return"unit-value";throw new Error("InternalError: Found unknown sizeVV type")}export{c as createVisualVariableColor,v as createVisualVariableOpacity,V as createVisualVariableRotation,z as createVisualVariableSizeMinMaxValue,m as createVisualVariableSizeScaleStops,f as createVisualVariableSizeStops,S as createVisualVariableSizeUnitValue,y as createVisualVariableUniforms,h as getMaxSizeVVSize,x as noVisualVariables};
