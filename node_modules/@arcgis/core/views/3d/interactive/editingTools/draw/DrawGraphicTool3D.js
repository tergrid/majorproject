/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import{unitRGBAFromColor as t}from"../../../../../core/colorUtils.js";import{handlesGroup as i,makeHandle as s}from"../../../../../core/handleUtils.js";import{destroyMaybe as r}from"../../../../../core/maybe.js";import{watch as o,when as a,syncAndInitial as n,sync as l,initial as c}from"../../../../../core/reactiveUtils.js";import{property as p}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as h}from"../../../../../core/accessorSupport/decorators/subclass.js";import{s as m}from"../../../../../chunks/vec32.js";import{create as u}from"../../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{getEffectiveElevationInfo as d,getEffectiveElevationMode as v}from"../../../../../support/elevationInfoUtils.js";import f from"../../../../../symbols/support/ElevationInfo.js";import{SegmentLabels3D as g}from"../../SegmentLabels3D.js";import{SnappingVisualizer3D as w}from"../../SnappingVisualizer3D.js";import{meshTransformFastUpdateHandles as y}from"../meshFastUpdateUtils.js";import{Settings as E}from"../settings.js";import{ExtendedLineVisualElement as V}from"../../visualElements/ExtendedLineVisualElement.js";import{OutlineVisualElement as _}from"../../visualElements/OutlineVisualElement.js";import{VerticesVisualElement as j}from"../../visualElements/VerticesVisualElement.js";import{evaluateElevationAlignmentAtPoint as G}from"../../../layers/graphics/elevationAlignmentUtils.js";import{ElevationContext as L}from"../../../layers/graphics/ElevationContext.js";import{GraphicState as S}from"../../../layers/graphics/GraphicState.js";import{RenderOccludedFlag as x}from"../../../webgl-engine/lib/Material.js";import{DrawGraphicTool as D,geometryTypeToDrawOperationGeometryType as I}from"../../../../draw/DrawGraphicTool.js";import{DrawOperation as T}from"../../../../draw/DrawOperation.js";import{SceneDrawSurface as C,ElevationDrawSurface as O}from"../../../../draw/drawSurfaces.js";import{getDrawMeshHelpMessage as b}from"../../../../draw/support/helpMessageUtils3d.js";let z=class extends D{constructor(e){super(e),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this._settings=new E({getTheme:()=>this.view.effectiveTheme}),this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:e,offset:t,unit:i}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new f({mode:e,offset:t,unit:i});const s=this.geometryToPlace;s&&this.addHandles([o((()=>s.vertexSpace.origin),(()=>this.graphic?.notifyMeshTransformChanged()),l),o((()=>({vertexAttributes:s.vertexAttributes,alwaysUpdate:{}})),(()=>this.graphic?.notifyGeometryChanged()),l)])}normalizeCtorArgs(e){if(!e.elevationInfo){const t=e.hasZ??!0;return{...e,elevationInfo:d(t)}}return e}initializeGraphic(e){const{view:t}=this,s=this._createGraphicState=new S({graphic:e});return i([t.maskOccludee(e),t.trackGraphicState(s),o((()=>({element:this._outlineVisualElement,isDraped:s.isDraped})),(({element:e,isDraped:t})=>{e&&(e.isDraped=t)}),n),this._setupLoadingIndicator(s),...y(s,t)])}updateDrawMeshTooltipInfo(e){const{graphic:t,sketchOptions:i,view:s}=this;e.sketchOptions=i,e.viewType=s.type,e.helpMessage=b(t,this.view),this.updateElevation(e.elevation)}makeDrawOperation(){const{geometryType:e}=this,t="circle"!==e&&"rectangle"!==e;return new T({view:this.view,manipulators:this.manipulators,geometryType:I(e),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new C(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new O(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new w,segmentLabels:t?new g:null,labelOptions:this.sketchOptions.labels,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===v(this.hasZ,this.elevationInfo),cursor:this.cursor,constraintsEnabled:!0})}onActiveVertexChanged(e){const{view:a}=this;if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[e],this._activeVertexVisualElement.recreate(),this._updateVerticalLineVisualElement(e),s();const n=this._settings,l=n.manipulators.vertex,p=new j({view:a,spatialReference:a.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,size:l.size,outlineSize:l.outlineSize,renderOccluded:l.renderOccluded,attached:!1,isDecoration:!0});this._activeVertexVisualElement=p;const h=n.visualElements.zVerticalLine,m=new V({view:a,extensionType:h.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:x.OccludeAndTransparent,isDecoration:!0});this._verticalLineVisualElement=m;const u=i([o((()=>n.visualElements.zVerticalLine),(e=>e.apply(m)),c),o((()=>({selectedColor:t(n.colors.selected),outlineColor:t(n.manipulators.vertex.outlineColor)})),(({selectedColor:e,outlineColor:t})=>{p.color=e,p.outlineColor=t}),c),s((()=>{this._activeVertexVisualElement=r(this._activeVertexVisualElement),this._verticalLineVisualElement=r(this._verticalLineVisualElement)}))]);return p.attached=!0,this._updateVerticalLineVisualElement(e),u}_updateVerticalLineVisualElement(e){const t=this._verticalLineVisualElement;if(!t)return;const{renderCoordsHelper:i,elevationProvider:s}=this.view;m(M,e[0],e[1],e[2]),A.setFromElevationInfo(this.elevationInfo),M[2]=G(M,s,A,i);i.toRenderCoords(M,this.view.spatialReference,M)?(t.setStartEndFromWorldDownAtLocation(M),t.attached=!0):t.attached=!1}onOutlineChanged(e){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=e,s();const t=this.internalGraphicsLayer.elevationInfo,{view:a}=this,n=this._settings,l=new _({view:a,geometry:e,elevationInfo:t,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===v(this.hasZ,t),attached:!1,isDecoration:!0});this._outlineVisualElement=l;const p=i([o((()=>n.visualElements.lineGraphics.outline),(e=>e.apply(l)),c),o((()=>n.visualElements.lineGraphics.shadowStyle),(e=>e.apply(l)),c),s((()=>{this._outlineVisualElement=r(this._outlineVisualElement)}))]);return l.attached=!0,l.laserlineEnabled=!0,p}onRegularVerticesChanged(e){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=e,s();const{view:a}=this,n=this._settings,l=n.manipulators.vertex,p=new j({view:a,spatialReference:a.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,size:l.size,outlineSize:l.outlineSize,renderOccluded:l.renderOccluded,attached:!1,isDecoration:!0}),h=i([o((()=>({color:t(n.manipulators.vertex.color),outlineColor:t(n.manipulators.vertex.outlineColor)})),(({color:e,outlineColor:t})=>{p.color=e,p.outlineColor=t}),c),s((()=>{this._verticesVisualElement=r(this._verticesVisualElement)}))]);return p.attached=!0,this._verticesVisualElement=p,h}updateGraphicGeometry(e){if("mesh"!==this.geometryType||"point"!==e?.type)super.updateGraphicGeometry(e);else{const t=this.geometryToPlace;t?.centerAt(e);const i=this._graphic;t&&i.geometry===t||(i.geometry=t)}}_setupLoadingIndicator(e){const{drawOperation:t}=this;if(!this.geometryToPlace)return t.loading=!1,null;t.loading=!0;const r=s((()=>{t.loading=!1}));let o;const l=()=>o&&cancelAnimationFrame(o);return i([a((()=>e.displaying),(()=>{l(),o=requestAnimationFrame((()=>r.remove()))}),{...n,once:!0}),s(l),r])}};e([p({constructOnly:!0})],z.prototype,"elevationInfo",void 0),e([p({constructOnly:!0})],z.prototype,"geometryType",void 0),e([p()],z.prototype,"type",void 0),e([p({constructOnly:!0})],z.prototype,"view",void 0),z=e([h("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],z);const A=new L,M=u();export{z as DrawGraphicTool3D};
