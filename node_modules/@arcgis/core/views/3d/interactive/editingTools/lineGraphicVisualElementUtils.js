/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{removeHandles as e,handlesGroup as t,destroyHandle as a,refHandle as n}from"../../../../core/handleUtils.js";import{deg2rad as i}from"../../../../core/mathUtils.js";import{watch as l,initial as o}from"../../../../core/reactiveUtils.js";import{signal as r}from"../../../../core/signal.js";import{s,g as p,h as c}from"../../../../chunks/vec32.js";import{create as h}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{getGraphicEffectiveElevationInfo as m}from"../../../../support/elevationInfoUtils.js";import{Manipulator3D as u}from"../Manipulator3D.js";import{GrabbingState as d}from"./GrabbingState.js";import{ManipulatorState as g}from"./ManipulatorState.js";import{ManipulatorType as f}from"./ManipulatorType.js";import{Settings as v}from"./settings.js";import{ExtendedLineVisualElement as y}from"../visualElements/ExtendedLineVisualElement.js";import{LaserlineVisualElement as E}from"../visualElements/LaserlineVisualElement.js";import{OutlineVisualElement as w}from"../visualElements/OutlineVisualElement.js";import{GraphicState as S}from"../../layers/graphics/GraphicState.js";import{RenderOccludedFlag as b}from"../../webgl-engine/lib/Material.js";function j(t){const{view:a,graphic:n}=t,i=new S({graphic:n}),l=M(t,i),o=[l,T(t,l.visualElement,i),a.maskOccludee(n),a.trackGraphicState(i)];return{visualElement:l.visualElement,remove:()=>e(o)}}function M(e,n){const{view:i,graphic:r}=e,s=new w({view:i,geometry:L(r)?r.geometry:null,elevationInfo:m(r),attached:!1,isDecoration:!0}),p=new v({getTheme:()=>i.effectiveTheme}),c=()=>{s.attached=n.displaying},h=t([l((()=>p.visualElements.lineGraphics.outline),(e=>e.apply(s)),o),l((()=>p.visualElements.lineGraphics.shadowStyle),(e=>e.apply(s)),o),l((()=>n.displaying),c),l((()=>n.isDraped),(e=>{s.isDraped=e})),n.on("changed",(()=>s.geometry=L(r)?r.geometry:null)),a(s)]);return c(),{visualElement:s,remove:()=>h.remove()}}function T(s,p,c){const{graphic:h,view:u}=s,f=[],w=m(h),S="on-the-ground"===w.mode||!w.offset&&"absolute-height"!==w.mode,j=new g,M=new v({getTheme:()=>u.effectiveTheme}),T=M.visualElements,A=new y({view:u,extensionType:T.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:b.OccludeAndTransparent,isDecoration:!0}),x=i(T.heightPlaneAngleCutoff),C=new E({view:u,attached:!1,angleCutoff:x,isDecoration:!0}),O=r(1);f.push(l((()=>({lineShadowStyle:M.visualElements.lineGraphics.shadowStyle,pointShadowStyle:M.visualElements.pointGraphics.shadowStyle,alpha:O.value})),(({lineShadowStyle:e,pointShadowStyle:t,alpha:a})=>{e.apply(p,a),t.apply(A,a)}),o));const V=r(1);f.push(l((()=>({heightPlane:M.visualElements.heightPlane,alpha:V.value})),(({heightPlane:e,alpha:t})=>e.apply(C,t)),o));const P=()=>{if(j.update(s),!c.displaying||S&&(c.isDraped||!L(h)||!h.geometry.hasZ))return p.laserlineEnabled=!1,A.attached=!1,void(C.attached=!1);p.laserlineEnabled=!0;const e=j.grabbingState&d.XY?T.laserlineAlphaMultiplier:1;O.value=e;const t=j.grabbingState&d.Z?T.laserlineAlphaMultiplier:1;V.value=t,D(A,j),G(s,p,C,j)};f.push(l((()=>M.visualElements.zVerticalLine),(e=>e.apply(A)),o)),f.push(c.on("changed",P),l((()=>c.displaying),P),p.events.on("attachment-origin-changed",P),a(A),a(C));const U=[],X=()=>{e(U),U.length=0,s.forEachManipulator((e=>U.push(e.events.on("grab-changed",P)))),s.forEachManipulator((e=>U.push(e.events.on("select-changed",P)))),P()};return X(),f.push(s.onManipulatorsChanged(X),n((()=>t(U)))),t(f)}function D(e,t){const a=1===t.numSelected?t.firstSelected:t.numSelected>1&&null!=t.firstGrabbedXY?t.firstGrabbedXY:null;null!=a?(e.setStartEndFromWorldDownAtLocation(a.renderLocation),e.attached=!0):e.attached=!1}function G(e,t,a,n){if(n.numSelected>0){s(A,0,0,0);let t=0;e.forEachManipulator(((e,a)=>{a===f.TRANSLATE_XY&&e.selected&&e instanceof u&&(p(A,A,e.renderLocation),t++)})),t>0?(a.heightManifoldTarget=c(A,A,1/t),a.attached=!0):a.attached=!1}else{const n=t.attachmentOrigin;null!=n&&e.view.renderCoordsHelper.toRenderCoords(n,A)?(a.heightManifoldTarget=A,a.attached=!0):a.attached=!1}}function L(e){return null!=e.geometry&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const A=h();export{j as createVisualElements};
