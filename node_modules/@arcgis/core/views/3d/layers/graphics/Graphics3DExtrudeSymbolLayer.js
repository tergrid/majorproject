/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import e from"../../../../core/Error.js";import{clone as t}from"../../../../core/lang.js";import{getMetersPerVerticalUnitForSR as r}from"../../../../core/unitUtils.js";import{e as s}from"../../../../chunks/earcut.js";import{normalFromMat4 as i}from"../../../../core/libs/gl-matrix-2/math/mat3.js";import{create as n}from"../../../../core/libs/gl-matrix-2/factories/mat3f64.js";import{invert as o,invertOrIdentity as a}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as l}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{c,n as m,s as h,f as p,b as g,e as d}from"../../../../chunks/vec32.js";import{fromArray as u,create as f}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{computeTranslationToOriginAndRotation as y}from"../../../../geometry/projection/computeTranslationToOriginAndRotation.js";import{create as b,empty as _,expandWithBuffer as x,intersectsClippingArea as j}from"../../../../geometry/support/aaBoundingBox.js";import{newDoubleArray as P}from"../../../../geometry/support/DoubleArray.js";import{newIndexArray as S,getZeroIndexArray as w}from"../../../../geometry/support/Indices.js";import{a as E}from"../../../../chunks/vec3.js";import{makeVertexCandidate as v,makeEdgeCandidate as I}from"../../../../layers/graphics/data/SnappingCandidate.js";import{getDriverAxisSizeValue as C}from"../../../../renderers/support/renderingInfoUtils.js";import{ViewingMode as L}from"../../../ViewingMode.js";import{needsElevationUpdates3D as M,SampleElevationInfo as O}from"./elevationAlignmentUtils.js";import{Graphics3DObject3DGraphicLayer as A}from"./Graphics3DObject3DGraphicLayer.js";import{Graphics3DSymbolLayer as z}from"./Graphics3DSymbolLayer.js";import{validateSymbolLayerSize as B,computeCentroid as D}from"./graphicUtils.js";import{ApplyRendererDiffResult as G}from"./interfaces.js";import{geometryAsPolygon as R}from"./polygonUtils.js";import{createMaterial as T}from"../support/edgeUtils.js";import{debugFlags as U}from"../../support/debugFlags.js";import{SamplePosition as N}from"../../support/ElevationProvider.js";import{geometryToRenderInfo as V}from"../../support/renderInfoUtils/polygon.js";import{NormalType as k}from"../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl.js";import{Attribute as H}from"../../webgl-engine/lib/Attribute.js";import{CullFaceOptions as F}from"../../webgl-engine/lib/basicInterfaces.js";import{ContentObjectType as W}from"../../webgl-engine/lib/ContentObjectType.js";import{Geometry as q}from"../../webgl-engine/lib/Geometry.js";import{isGeometryWithMapPositions as Z}from"../../webgl-engine/lib/GeometryWithMapPositions.js";import{compressNormals as J}from"../../webgl-engine/lib/Normals.js";import{Object3D as K}from"../../webgl-engine/lib/Object3D.js";import{VertexAttribute as Q}from"../../webgl-engine/lib/VertexAttribute.js";import{DefaultMaterial as X}from"../../webgl-engine/materials/DefaultMaterial.js";const Y=["polygon","extent"];class $ extends z{constructor(e,t,r,s){super(e,t,r,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const t=B(this._getSymbolSize());if(t)throw new e("graphics3dextrudesymbollayer:invalid-size",t)}const t=this.symbolLayer?.material?.color,r=this._getCombinedOpacityAndColor(t),s=u(r),i=r[3],n=i<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:s,ambient:s,opacity:i,transparent:n,cullFace:n?F.None:F.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:k.Compressed};this._materials[xe.Main]=new X(o),this._materials[xe.Bottom]=new X({...o,cullFace:F.Back}),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Y,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(t);return this._createAs3DShape(t,e.renderingInfo,r,s,t.uid)}layerOpacityChanged(e,t){const r=this.symbolLayer?.material?.color,s=this._getCombinedOpacity(r),i=s<1||this.needsDrivenTransparentPass;this._materials[xe.Main]?.setParameters({opacity:s,transparent:i}),this._materials[xe.Bottom]?.setParameters({opacity:s,transparent:i});const n=this._getLayerOpacity();e.forEach((e=>{const r=t(e);null!=r&&r.layerOpacityChanged(n,this._context.isAsync)}))}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,M)}slicePlaneEnabledChanged(e,t){return this._materials[xe.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[xe.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach((e=>{const r=t(e);null!=r&&r.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[xe.Main]?.setParameters(e),this._materials[xe.Bottom]?.setParameters(e),!0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?C(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?G.RecreateSymbol:G.RecreateGraphics}async queryForSnapping(e,s,i,n){const o=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/r(s),{objectId:a,target:l}=e,c=t(l);switch(c.z=(c.z??0)+o,e.type){case"edge":{const{start:r,end:s}=e,i=t(r),n=t(s);return i.z=(i.z??0)+o,n.z=(n.z??0)+o,[I(a,c,1/0,i,n)]}case"vertex":return[v(a,c,1/0),I(a,l,1/0,l,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,r,a,c){const m=R(e.geometry);if(null==m)return null;if(0===m.rings.length||!m.rings.some((e=>e.length>0)))return this._logGeometryValidationWarnings(m.rings,"rings","ExtrudeSymbol3DLayer"),null;const h=V(m,this._context.elevationProvider,this._context.renderCoordsHelper,a);this._logGeometryCreationWarnings(h,m.rings,"rings","ExtrudeSymbol3DLayer");const p=D(m);if(null==p)return null;const g=new Array,d=new Array,u=b(),w=l(),v=f(),I=this._context.renderCoordsHelper.viewingMode===L.Global;I||this._context.renderCoordsHelper.worldUpAtPosition(null,v),y(m.spatialReference,[p.x,p.y,0],w,this._context.renderCoordsHelper.spatialReference);const C=l();o(C,w);const O=n();i(O,C);const{polygons:z,mapPositions:B,position:G}=h;for(const i of z){const e=i.count;if(this._context.clippingExtent&&(_(u),x(u,i.mapPositions),!j(u,this._context.clippingExtent)))continue;const n=s(i.mapPositions,i.holeIndices,3);if(0===n.length)continue;const o=n.length,a=6*e,l=S(a+o),m=S(o),h=P(3*a),p=P(3*a),f=P(3*a),y=P(a);te(G,B,n,i,h,f,p,y,l,m,this._getExtrusionSize(t),v,I),E(h,h,C);const b=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:c,layerUid:this._context.layer.uid}),w=new je(h,f,J(p),y);g.push(ee(this._materials[xe.Main],l,l.length-m.length,w,r,b),ee(this._materials[xe.Bottom],m,0,w,r,b)),d.push(w.heights)}if(0===g.length)return null;const U=new K({geometries:g,layerUid:this._context.layer.uid,graphicUid:c,isElevationSource:!0});U.transformation=w;const N=T(this.symbolLayer,{opacity:this._getLayerOpacity()}),k=null!=N?{baseMaterial:this._materials[xe.Main],edgeMaterials:[N],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,H=new A(this,U,g,null,null,((e,t,r,s,i)=>ge(e,t,r,s,i,d)),a,k);return H.alignedSampledElevation=h.sampledElevation,H.needsElevationUpdates=M(a.mode),H}}function ee(e,t,r,s,i,n){const o=w(t.length),a=[[Q.POSITION,new H(s.positions,t,3,!0)],[Q.NORMALCOMPRESSED,new H(s.normals,t,2,!0)],[Q.COLOR,new H(i,o,4,!0)]];return new q(e,a,s.elevation,W.Mesh,n,r)}function te(e,t,r,s,i,n,o,a,l,c,m,h,p){const g=r.length/3;let d=0,u=2*s.count;re(e,t,s.index,s.count,r,0,g,i,n,o,a,l,c,u,m,h,p);let f=2*s.count;u=0,ne(i,n,a,o,d,s.pathLengths[0],s.count,f,l,u,m),f+=4*s.pathLengths[0],u+=2*s.pathLengths[0],d+=s.pathLengths[0];for(let y=1;y<s.pathLengths.length;++y)ne(i,n,a,o,d,s.pathLengths[y],s.count,f,l,u,m),f+=4*s.pathLengths[y],u+=2*s.pathLengths[y],d+=s.pathLengths[y]}function re(e,t,r,s,i,n,o,a,l,h,p,g,d,u,f,y,b){c(ue,y);const _=f>0?1:-1;let x=3*r,j=0,P=3*j,S=s,w=3*S;for(let c=0;c<s;++c)b&&(ue[0]=e[x],ue[1]=e[x+1],ue[2]=e[x+2],m(ue,ue)),a[P]=e[x],a[P+1]=e[x+1],a[P+2]=e[x+2],l[P]=t[x],l[P+1]=t[x+1],l[P+2]=t[x+2],h[P]=-_*ue[0],h[P+1]=-_*ue[1],h[P+2]=-_*ue[2],p[j]=0,a[w]=e[x]+f*ue[0],a[w+1]=e[x+1]+f*ue[1],a[w+2]=e[x+2]+f*ue[2],l[w]=t[x],l[w+1]=t[x+1],l[w+2]=t[x+2],h[w]=_*ue[0],h[w+1]=_*ue[1],h[w+2]=_*ue[2],p[S]=f,P+=3,w+=3,x+=3,j+=1,S+=1;x=3*n,P=0,w=3*u;const E=f<0?be:ye,v=f<0?ye:be;for(let c=0;c<o;++c)d[P]=i[x+E[0]],d[P+1]=i[x+E[1]],d[P+2]=i[x+E[2]],g[w]=i[x+v[0]]+s,g[w+1]=i[x+v[1]]+s,g[w+2]=i[x+v[2]]+s,P+=3,w+=3,x+=3}function se(e,t,r,s,i,n,o){s[n]=s[o],o*=3,e[n*=3]=e[o],e[n+1]=e[o+1],e[n+2]=e[o+2],t[n]=t[o],t[n+1]=t[o+1],t[n+2]=t[o+2],r[n]=i[0],r[n+1]=i[1],r[n+2]=i[2]}const ie=f();function ne(e,t,r,s,i,n,o,a,l,c,m){let h=i,p=i+1,g=i+o,d=i+o+1,u=a,f=a+1,y=a+2*n,b=a+2*n+1;m<0&&(h=i+o+1,d=i),c*=3;for(let _=0;_<n;++_)_===n-1&&(m>0?(p=i,d=i+o):(p=i,h=i+o)),he(e,h,p,g,ie),se(e,t,s,r,ie,u,h),se(e,t,s,r,ie,f,p),se(e,t,s,r,ie,y,g),se(e,t,s,r,ie,b,d),l[c++]=u,l[c++]=y,l[c++]=b,l[c++]=u,l[c++]=b,l[c++]=f,h++,p++,g++,d++,u+=2,f+=2,y+=2,b+=2}const oe=f(),ae=f(),le=f(),ce=f(),me=f();function he(e,t,r,s,i){t*=3,r*=3,s*=3,h(oe,e[t++],e[t++],e[t++]),h(ae,e[r++],e[r++],e[r++]),h(le,e[s++],e[s++],e[s++]),p(ce,ae,oe),p(me,le,oe),g(i,me,ce),m(i,i)}const pe=f();function ge(e,t,r,s,i,n){const o=e.stageObject,c=o.geometries,m=c.length,p="absolute-height"!==t.mode;let g=0;const u=o.transformation,f=a(l(),u);for(let a=0;a<m;a+=2){const e=c[a];if(!Z(e))continue;const t=e.getMutableAttribute(Q.POSITION).data,l=n[a/2],m=new N(e.mapPositions),y=t.length/3;let b=0,_=!1,x=0;for(let n=0;n<y;n++){pe[0]=t[b],pe[1]=t[b+1],pe[2]=t[b+2],s(m,fe),p&&(x+=fe.sampledElevation),U.TESTS_DISABLE_OPTIMIZATIONS?(h(de,m.array[m.offset],m.array[m.offset+1],fe.z+l[b/3]),null!=r&&i.toRenderCoords(de,r,de),d(de,de,f)):(h(de,t[b],t[b+1],t[b+2]),d(de,de,u),i.setAltitude(de,fe.z+l[b/3]),d(de,de,f)),t[b]=de[0],t[b+1]=de[1],t[b+2]=de[2];const e=_e/i.unitInMeters;(Math.abs(pe[0]-t[b])>=e||Math.abs(pe[1]-t[b+1])>=e||Math.abs(pe[2]-t[b+2])>=e)&&(_=!0),m.offset+=3,b+=3}_&&(e.invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(c[a],Q.POSITION),c[a+1].invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(c[a+1],Q.POSITION)),g+=x/y}return g/m}const de=f(),ue=f(),fe=new O,ye=[0,2,1],be=[0,1,2],_e=.01;var xe;!function(e){e[e.Main=0]="Main",e[e.Bottom=1]="Bottom"}(xe||(xe={}));class je{constructor(e,t,r,s){this.positions=e,this.elevation=t,this.normals=r,this.heights=s}}export{$ as Graphics3DExtrudeSymbolLayer};
