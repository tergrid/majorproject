/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{getTranslation as t,multiply as e,invert as a,copy as r,fromTranslation as s}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{IDENTITY as i,create as o}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{h as n}from"../../../../chunks/vec32.js";import{create as m}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{perObjectElevationAligner as f}from"./ElevationAligners.js";import{evaluateElevationInfoAtPoint as l}from"./elevationAlignmentUtils.js";import{setContextFeature as d}from"./featureExpressionInfoUtils.js";import{Graphics3DObject3DGraphicLayer as g}from"./Graphics3DObject3DGraphicLayer.js";class c extends g{constructor(){super(...arguments),this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}enableFastTransformUpdates(e,a){if(this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!0;const{stageObject:r}=this,s=r.geometries.slice();r.removeAllGeometries();const i=t(h,r.transformation),o=a.getOrigin(i);for(const t of s){const a=e(t.material),s=t.instantiate({material:a});s.localOrigin=o,r.addGeometry(s)}this._originalGeometries=s}disableFastTransformUpdates(t){if(!this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!1;const{stageObject:e}=this,a=e.geometries.map((e=>t(e.material)));e.removeAllGeometries();for(let r=0;r<this._originalGeometries.length;r++){const t=this._originalGeometries[r],s=a[r];s.setParameters({modelTransformation:null}),s===t.material?e.addGeometry(t):e.addGeometry(t.instantiate({material:s}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,a,r){if(!this._fastTransformUpdatesEnabled)return;const{stageObject:s}=this;if(0===s.geometries.length)return;const o=s.geometries[0].localOrigin,n=t(h,e),m=r.getOrigin(n);if(m===o)return;const f=a?.localMatrix??i;s.shaderTransformation=null,s.transformation=e,s.geometries.forEach((t=>{t.transformation=f,t.localOrigin=m}))}updateTransform(t,r,s){const{stageObject:o}=this,n=r?.localMatrix??i;if(!this._fastTransformUpdatesEnabled)return o.shaderTransformation=null,o.transformation=t,o.geometries.forEach((t=>{t.transformation=n})),void(this._fastUpdateEdgeTransform()||this.resetEdgeObject(s));const m=o.transformation,f=o.geometries[0].transformation,l=t,d=n,g=e(p,m,f),c=e(T,l,d),h=e(E,c,a(E,f));o.shaderTransformation=h,this._setFastMaterialTransformation({matA:g,matB:c}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(s)}alignWithElevation(t,a,s,i){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(t,a,s,i);null!=s&&d(this.elevationContext.featureExpressionInfoContext,s);const o=(e,r)=>l(e,t,this.elevationContext,a,r),{stageObject:n}=this;if(!n.geometries[0].material.parameters.modelTransformation)return;const m=n.transformation,g=n.geometries[0].transformation,c=e(p,m,g),h=n.effectiveTransformation,E=r(b,h);this.alignedSampledElevation=f(this,this.elevationContext,t.spatialReference,o,a,E),n.shaderTransformation=E;const u=n.geometries[0].transformation,_=e(T,E,u);this._setFastMaterialTransformation({matA:c,matB:_}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(i)}_setFastMaterialTransformation({matA:t,matB:r}){const{stageObject:i}=this;if(0===i.geometries.length)return;const o=i.geometries[0].localOrigin,m=s(j,n(h,o.vec3,-1)),f=e(u,m,t),l=e(_,m,r),d=a(u,f),g=e(_,l,d);for(const e of i.geometries)e.material.setParameters({modelTransformation:g})}_fastUpdateEdgeTransform(){return this._stageLayer.stage.renderer.ensureEdgeView().fastUpdateObject3DEdgesTransform(this.stageObject)}}const h=m(),p=o(),T=o(),b=o(),E=o(),u=o(),_=o(),j=o();export{c as Graphics3DMeshObject3DGraphicLayer};
