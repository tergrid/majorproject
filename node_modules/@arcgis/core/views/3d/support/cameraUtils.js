/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../../../Camera.js";import{Cyclical as n}from"../../../core/Cyclical.js";import t from"../../../core/Logger.js";import{deg2rad as r,rad2deg as o}from"../../../core/mathUtils.js";import{throwIfAborted as i}from"../../../core/promiseUtils.js";import{h as a,g as c,o as l,c as s}from"../../../chunks/vec32.js";import{clone as u,create as f}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{getReferenceEllipsoid as m}from"../../../geometry/ellipsoidUtils.js";import p from"../../../geometry/Point.js";import{projectWithZConversion as d,project as h}from"../../../geometry/projection.js";import g from"../../../geometry/SpatialReference.js";import{projectPointToVector as y,projectPointToVectorAsync as v}from"../../../geometry/projection/projectPointToVector.js";import{projectVectorToPoint as w,projectVectorToPointAsync as R}from"../../../geometry/projection/projectVectorToPoint.js";import{projectVectorToVector as x}from"../../../geometry/projection/projectVectorToVector.js";import{ViewingMode as M}from"../../ViewingMode.js";import{cameraOnContentAlongViewDirection as S}from"../camera/intersectionUtils.js";import{t as T,c as j}from"../../../chunks/cameraUtilsPlanar.js";import{t as C,c as z}from"../../../chunks/cameraUtilsSpherical.js";import{getGreatCircleSpanAt as b}from"./earthUtils.js";import{getElevationAtPoint as U}from"./ElevationProvider.js";import{isSpatialReferenceSupported as P}from"../../support/spatialReferenceSupport.js";const A=()=>t.getLogger("esri.views.3d.support.cameraUtils"),D=39.37,H=96,L=1,G=8,E=5,O=1,q=f(),I={heading:0,tilt:0},k=f(),J=new n(-20037508.342788905,20037508.342788905),V=new n(-180,180);var F;function W(e){return e.spatialReference??g.WGS84}function X(e){return"global"===e.viewingMode?z:j}function K(e,n,t,r,o){return X(e).headingTiltToDirectionUp(n,t,r,o)}function Y(e,n){if(null==n)return null;const t=e.renderSpatialReference,o=X(e).headingTiltToDirectionUp,i=f();if(!y(n.position,i,t))return null;const l=o(i,n.heading,n.tilt);a(l.direction,l.direction,e.state.camera.distance),c(l.direction,l.direction,i);const s=S(e,i,l.direction,l.up);return s.fov=r(n.fov),s.row=n.layout.row,s.rows=n.layout.rows,s.column=n.layout.column,s.columns=n.layout.columns,s}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(F||(F={}));const N=f();function Z(n,t,r){const i=n.renderSpatialReference,a=ne(n,t.eye,t.viewForward,t.up,I);let c=W(n);return x(t.eye,i,N,c)||(c=g.WGS84,x(t.eye,i,N,c)),null==r?r=new e(new p(N,c),a.heading,a.tilt,o(t.fov)):(r.position.x=N[0],r.position.y=N[1],r.position.z=N[2],r.position.spatialReference=c,r.heading=a.heading,r.tilt=a.tilt,r.fov=o(t.fov)),r.layout.row=t.row,r.layout.rows=t.rows,r.layout.column=t.column,r.layout.columns=t.columns,r}function B(e,n,t){const o=e.state.camera,i=o.width/2/o.pixelRatio;e.renderCoordsHelper.viewingMode===M.Global&&null!=t&&(n*=Math.cos(r(t))),n/=e.renderCoordsHelper.unitInMeters;return i/(H*D/n)/Math.tan(o.fovX/2)}function Q(e,n,t){const o=e.state.camera,i=n*Math.tan(o.fovX/2),a=o.width/2/o.pixelRatio;let c=H*D/(a/i);return e.renderCoordsHelper.viewingMode===M.Global&&null!=t&&(c/=Math.cos(r(t))),c*e.renderCoordsHelper.unitInMeters}async function $(e,n,t,r,o,i){return ee(e,n,B(e,t,n.latitude),r,o,i)}function _(e,n,t,r,o,i){return Ce(e,ae(e,r.heading,r.tilt,n,t,o),r.fov,i)}async function ee(e,n,t,r,o,a){const c=await ce(e,r.heading,r.tilt,n,t,o,a);return i(a),ze(e,c,r.fov,a)}function ne(e,n,t,r,o){return X(e).directionToHeadingTilt(n,t,r,o)}function te(e,n){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(n,k,e.spatialReference)&&e.elevationProvider&&(U(e.elevationProvider,k)??0)>k[2]-O)}async function re(e,n,t){if(te(e,n))return!0;const{elevationProvider:r,spatialReference:o,renderCoordsHelper:a}=e;if(null==r||!a.fromRenderCoords(n,k,o))return!1;const[c,l,s]=k,u=await r.queryElevation(c,l,s,o,"ground",t)??0;return i(t),u>s-O}async function oe(e,n,t){const r=f();if(null==n)return s(r,e.state.camera.center);if(n instanceof p){const{renderSpatialReference:o,basemapTerrain:a,elevationProvider:c}=e,l=n.spatialReference;if(await v(n,r,o,0,{signal:t}),i(t),null==n.z&&null!=a&&null!=c){const o=await c.queryElevation(n.x,n.y,n.z??0,l,"ground",t);i(t),null!=o&&e.renderCoordsHelper.setAltitude(r,o)}return r}return s(r,n)}function ie(e,n){const t=f();if(null==n)return s(t,e.state.camera.center);if(n instanceof p){if(!y(n,t,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:o}=e;if(null==n.z&&null!=r&&null!=o){const r=U(o,n);null!=r&&e.renderCoordsHelper.setAltitude(t,r)}return t}return s(t,n)}function ae(e,n,t,r,o,i){return le(e,n,t,r instanceof p?r:null,ie(e,r),o,i)}async function ce(e,n,t,r,o,a,c){const l=r instanceof p?r:null,s=await oe(e,r,c);return i(c),se(e,n,t,l,s,o,a,c)}function le(e,n,t,r,o,i,a){if(null==o)return null;if(!r&&(r=new p({spatialReference:W(e)}),!w(o,e.renderSpatialReference,r)))return null;const c=ue(e,n,t,o,i,a);if(fe(e,t,a)&&te(e,c.eye)){const{tilt:a,mode:c}=me(e,t,o,i);return le(e,n,a,r,o,i,c)}return pe(c,o)}async function se(e,n,t,r,o,a,c,l){r||(r=new p({spatialReference:W(e)}),await R(o,e.renderSpatialReference,r,{signal:l})||(r=null)),i(l);const s=ue(e,n,t,o,a,c);if(fe(e,t,c)&&await re(e,s.eye,l)){i(l);const{tilt:c,mode:s}=me(e,t,o,a);return se(e,n,c,r,o,a,s,l)}return pe(s,o)}function ue(e,n,t,r,o,i){const a=Re(e,n,t,r,o=Math.max(o,e.state.constraints.minimumPoiDistance),i);return(0,X(e).eyeForCenterWithHeadingTilt)(r,o,a.heading,a.tilt)}function fe(e,n,t){const r=e.map.ground.navigationConstraint;return t===F.ADJUST&&"global"===e.viewingMode&&n>0&&(null==r||"stay-above"===r.type)}function me(e,n,t,r){const o=Te(e,t,r,Se(e,r,n,t));return{tilt:o,mode:n-o<1?F.LOCKED:F.ADJUST}}function pe(e,n){return{...e,center:u(n)}}function de(e,n){const{state:t,spatialReference:r}=e,o=n.spatialReference;return t.isGlobal&&P(o,M.Global)||t.isLocal&&r.equals(o)}function he(e,n){let t,r,o;if(e.state.isGlobal){const e=new p(n.xmin,n.ymin,n.spatialReference),i=new p(n.xmax,n.ymax,n.spatialReference),a=n.spatialReference.isGeographic?V:J;t=new p({x:a.center(e.x,i.x),y:(i.y+e.y)/2,z:null!=n.zmax&&null!=n.zmin?(n.zmax+n.zmin)/2:void 0,spatialReference:n.spatialReference});const c=m(n.spatialReference),l=b(t,e,i);r=l.lon,o=l.lat,a.diff(e.x,i.x)>a.range/2&&(r+=c.halfCircumference),r=Math.min(r,c.halfCircumference),o=Math.min(o,c.halfCircumference)}else{const i=e.renderSpatialReference??n.spatialReference;i.equals(n.spatialReference)||(n=h(n,i)),r=n.xmax-n.xmin,o=n.ymax-n.ymin;const a=null!=n.zmax&&null!=n.zmin?(n.zmax+n.zmin)/2:void 0;t=new p({x:n.xmin+.5*r,y:n.ymin+.5*o,z:a,spatialReference:i})}const i=null!=n.zmax&&null!=n.zmin?n.zmax-n.zmin:0,a=e.state.camera,c=1/Math.tan(a.fovX/2),l=1/Math.tan(a.fovY/2),s=1/Math.tan(a.fov/2);return{center:t,distance:Math.max(.5*r*c,.5*o*l,.5*i*s)/L}}async function ge(e,n,t,r,o,a){const c=de(e,n)?n:await d(n,e.spatialReference,{signal:a});i(a);const{center:l,distance:s}=he(e,c),u=await ce(e,t,r,l,s,o,a);return i(a),ze(e,u,e.camera.fov,a)}function ye(e,n,t,r,o,i){let a;try{a=de(e,n)?n:h(n,e.spatialReference)}catch(u){return null}const{center:c,distance:l}=he(e,a),s=ae(e,t,r,c,l,o);return null==s?null:Ce(e,s,e.camera.fov,i)}function ve(e,n,t){const r=e.renderSpatialReference,o=new p({spatialReference:W(e)});if(!w(t,r,o))return null;const i=Math.tan(n.fovX/2),a=Math.tan(n.fovY/2),c=l(n.eye,t),s=2*c*i*L,u=2*c*a*L;return"global"===e.viewingMode?C(e,o,s,u):T(e,o,s,u)}function we(e,n,t){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(t/r)/Math.LN2>G)return!0;const o=e.renderSpatialReference,i=W(e),a=new p({spatialReference:i});if(!w(n,o,a))return!1;const c=new p({spatialReference:i});if(!w(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,o,c))return!1;const l=Math.tan(.5*e.state.camera.fov)*r;return c.distance(a)/l>E}function Re(e,n,t,r,o,i){let a=0;return i===F.ADJUST&&we(e,r,o)?(n=0,a=Me(e,o,t,r)):a=je(e,r,o,t),a=e.state.constraints.clampTilt(o,a),{heading:n,tilt:t=Te(e,r,o,a)}}const xe=.7;function Me(e,n,t,r){const o=je(e,r,n,t);if(!e.state.constraints.tilt)return o;const i=e.state.constraints.tilt(n);i.max=Math.min(i.max,.5*Math.PI);const a=i.min*(1-xe)+i.max*xe;return Math.min(o,a)}function Se(e,n,t,r){let o=je(e,r,n,t);if(!e.state.constraints.tilt)return o;const i=e.state.constraints.tilt(n);return o=Math.min(o,.5*Math.PI),i.min*(1-xe)+o*xe}function Te(e,n,t,r){return X(e).lookAtTiltToEyeTilt(r,n,t)}function je(e,n,t,r){return X(e).eyeTiltToLookAtTilt(r,n,t)}function Ce(n,t,r,o){if(null==t)return null;const i=n.renderSpatialReference,a=new p({spatialReference:W(n)});return w(t.eye,i,a)?(o??=new e,o.position=a,o.heading=t.heading,o.tilt=t.tilt,o.fov=r,o):null}async function ze(n,t,r,o){const a=n.renderSpatialReference,c=new p({spatialReference:W(n)});return await R(t.eye,a,c,{signal:o}),i(o),new e(c,t.heading,t.tilt,r)}function be(e,n){const t=e.basemapTerrain?.tilingScheme;if(t)return t.levelAtScale(n);A().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Ue(e,n){const t=e.basemapTerrain?.tilingScheme;if(t)return t.scaleAtLevel(n);A().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Pe(e,n){return x(n.center,e.renderSpatialReference,q,g.WGS84),Q(e,n.distance,q[1])}export{F as OrientationMode,Pe as computeScale,ne as directionToHeadingTilt,Q as distanceToScale,Y as externalToInternal,ee as fromCenterDistanceAsync,_ as fromCenterDistanceSync,$ as fromCenterScale,ge as fromExtentAsync,ye as fromExtentSync,ce as getObserverForPointAtDistanceAsync,ae as getObserverForPointAtDistanceSync,W as getViewSR,K as headingTiltToDirectionUp,Z as internalToExternal,B as scaleToDistance,be as scaleToZoom,ve as toExtent,Ue as zoomToScale};
