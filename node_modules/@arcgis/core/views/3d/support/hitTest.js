/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import"../../../geometry.js";import e from"../../../Graphic.js";import{isIterable as r}from"../../../core/iteratorUtils.js";import{createScreenPointArray as n,screenPointObjectToArray as i}from"../../../core/screenUtils.js";import{create as t}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{projectVectorToVector as o}from"../../../geometry/projection/projectVectorToVector.js";import{fallbackObjectIDAttribute as s}from"../../../layers/LayerConstants.js";import{isIntegratedMeshLayer as c}from"../../../layers/support/layerUtils.js";import{debugFlags as l}from"./debugFlags.js";import{getElevationAtPoint as a}from"./ElevationProvider.js";import{newIntersector as u}from"../webgl-engine/lib/Intersector.js";import{StoreResults as p,IntersectorType as d}from"../webgl-engine/lib/IntersectorInterfaces.js";import{isValidIntersectorResult as f}from"../webgl-engine/lib/intersectorUtils.js";import{toOwner as g,toHit as m}from"../webgl-engine/lib/intersectorUtilsConversions.js";import{terrainId as h}from"../webgl-engine/lib/verticalOffsetUtils.js";import y from"../../../geometry/SpatialReference.js";import U from"../../../geometry/Point.js";async function b(e,r,i,t){const o=i?L(e,i):t,s=n(r.x,r.y);o.requiresGroundFeedback=!0,o.enableDraped=!0;const a=u(e.state.viewingMode);a.options.selectionMode=!0,a.options.store=p.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(s,a,o);const d=I(e,a.results.all,o.graphics),m=a.results.ground,h=g(m,e),y=null!=h&&"type"in h&&c(h.type)?h:null,U={screenPoint:r,results:d,ground:{mapPoint:E(e,m),distance:f(m)?m.distanceInRenderSpace:0,layer:y}};return l.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(U.intersector=a),U}function j(e,r,n,t){const o=n?L(e,n):t,s=null!=o.graphics&&(null!=o.graphics.include||null!=o.graphics.exclude),c=i(r);o.enableDraped=o.include&&!o.include.has(h)||o.exclude&&o.exclude.has(h);const l=e.sceneIntersectionHelper,a=u(e.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=s?p.ALL:p.MIN,a.options.hud=!n?.excludeHud,l.intersectIntersectorScreen(c,a,o),s){for(const r of a.results.all){const n=m(r,e);if(null==n)return E(e,r);if("graphic"!==n.type||S(o.graphics,n.graphic))return E(e,r)}return null}return E(e,a.results.min)}function I(e,r,n){const i=new Array;let t=null;for(let o=0;o<r.length;o++){const s=r[o],l=g(s,e);if(null!=l&&(l===e.map.ground||"type"in l&&c(l.type)))break;const a=m(s,e);if(null==a)continue;if("graphic"===a.type){if(null==t&&o!==r.length-1&&(t=new Set),null!=t){const e=w(a.graphic);if(t.has(e))continue;t.add(e)}if(!S(n,a.graphic))continue}const u=E(e,s),p=s.distanceInRenderSpace;if("media"===a.type){const e=a.element.toSource(u);i.push({...a,mapPoint:u,distance:p,sourcePoint:e})}else i.push({...a,mapPoint:u,distance:p})}return i}function E(e,r,n){return r.getIntersectionPoint(T)?(n=x(e,T,n),r.intersector===d.TERRAIN&&e.basemapTerrain&&(n.z=a(e.basemapTerrain,n)??0),n):null}function w(e){const r=e.sourceLayer,n=e.layer,i=r&&"objectIdField"in r?r:n&&"objectIdField"in n?n:r;if(i){const r=i.objectIdField??s,n=e.attributes?.[r];if(n)return`o-${i.id}-${n}`}return`u-${e.uid}`}function S(e,r){const n=w(r);return null==e||(null==e.include||e.include.has(n))&&(null==e.exclude||!e.exclude.has(n))}function x(e,r,n){let i=e.spatialReference||y.WGS84;return o(r,e.renderSpatialReference,T,i)?r=T:(i=y.WGS84,o(r,e.renderSpatialReference,T,i)&&(r=T)),n?(n.x=r[0],n.y=r[1],n.z=r[2],n.spatialReference=i):n=new U(r,i),n}function L(e,r){const n=R(e,r.include,D.INCLUDE),i=R(e,r.exclude,D.EXCLUDE);return{include:n.layerUids,exclude:i.layerUids,graphics:{include:n.graphicUids,exclude:i.graphicUids}}}function R(n,i,t,o={layerUids:void 0,graphicUids:void 0}){if(!i)return o;if(i instanceof e)v(o,w(i)),t===D.INCLUDE&&(null!=n.graphicsView&&i.layer===n?C(o,n.graphicsView.processor.layer.id):i.layer&&C(o,i.layer.uid));else if(r(i))for(const e of i)e===n.graphics&&null!=n.graphicsView?C(o,n.graphicsView.processor.layer.id):e===n.map.ground?C(o,h):R(n,e,t,o);else"uid"in i&&C(o,i.uid);return o}function C(e,r){e.layerUids||(e.layerUids=new Set),e.layerUids.add(r)}function v(e,r){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(r)}const T=t();var D;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(D||(D={}));export{x as computeMapPointFromVec3d,L as externalToInternalIntersectOptions,w as getGraphicFilterUid,b as hitTest,E as intersectResultToMapPoint,j as toMap};
