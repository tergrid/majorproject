/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{update as r}from"../../../../core/arrayUtils.js";import{unitRGBAFromColor as t}from"../../../../core/colorUtils.js";import has from"../../../../core/has.js";import{removeMaybe as s,destroyMaybe as i,releaseMaybe as a}from"../../../../core/maybe.js";import n from"../../../../core/PooledArray.js";import{watch as h,syncAndInitial as o,initial as d,sync as l}from"../../../../core/reactiveUtils.js";import{signal as _}from"../../../../core/signal.js";import{property as p}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/interfaces.js";import"../../../../core/accessorSupport/tracking/Flags.js";import"../../../../core/Warning.js";import"../../../../core/Error.js";import{equals as u,invert as c,multiply as m}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{IDENTITY as g,create as f}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{s as T}from"../../../../chunks/vec42.js";import{fromValues as A,ZEROS as E}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{a as b}from"../../../../chunks/boundedPlane.js";import{debugFlags as R}from"../../support/debugFlags.js";import{TransparencyMode as P}from"../../terrain/TerrainRenderer.js";import{DepthFormat as S,ColorFormat as C}from"../../webgl/formats.js";import{FBOCache as I}from"../core/FBOCache.js";import{RenderPassManager as O}from"../core/renderPasses/RenderPassManager.js";import{ShaderOutput as w}from"../core/shaderLibrary/ShaderOutput.js";import{HUDRenderStyle as y}from"../core/shaderLibrary/hud/HUDRenderStyle.js";import{RenderNodes as D}from"../effects/RenderNodes.js";import{isPrepareRenderPlugin as N}from"../effects/RenderPlugin.js";import{RenderPluginManager as L}from"../effects/RenderPluginManager.js";import{Blit as H}from"../effects/blit/Blit.js";import{Highlight as M}from"../effects/highlight/Highlight.js";import{ShadowHighlight as x}from"../effects/highlight/ShadowHighlight.js";import{SMAA as v}from"../effects/smaa/SMAA.js";import{SSAO as F}from"../effects/ssao/SSAO.js";import{AnimationTimeStep as U}from"./AnimationTimeStep.js";import{Decorations as q,RenderRequestType as j,StencilBits as G}from"./basicInterfaces.js";import{BoundingInfo as B}from"./BoundingInfo.js";import{zero as V,union as Q}from"./depthRange.js";import{depthRangeFromScene as k}from"./depthRangeUtils.js";import{RenderOccludedFlag as W}from"./Material.js";import{OffscreenRendering as X}from"./OffscreenRendering.js";import{RenderContext as Y,defaultRenderOccludedMask as z}from"./RenderContext.js";import{splitRenderGeometryChangeSetByMaterial as J,RendererTarget as K}from"./rendererUtils.js";import{setupFeatureDefaults as Z,RenderFeature as $}from"./RenderFeature.js";import{RenderSlot as ee}from"./RenderSlot.js";import{ShadowAccumulator as re}from"./ShadowAccumulator.js";import{ShadowMap as te,SnapshotSlot as se}from"./ShadowMap.js";import ie from"./SliceHelper.js";import{TransparencyPassType as ae}from"./TransparencyPassType.js";import{EdgeView as ne}from"./edgeRendering/EdgeView.js";import{Transparency as he}from"./edgeRendering/interfaces.js";import{MergedRenderer as oe}from"../materials/renderers/MergedRenderer.js";import{AlphaMode as de}from"../shaders/CompositingTechniqueConfiguration.js";import{RendererPerformanceInfo as le,PerformanceCategory as _e}from"../statistics/RendererPerformanceInfo.js";import{RenderState as pe}from"../../../support/RenderState.js";import{PixelFormat as ue,PixelType as ce,ClearBufferBit as me,DepthStencilAttachment as ge}from"../../../webgl/enums.js";class fe{constructor(e,r,s,i,a,n,l,p){this._stage=e,this._techniqueRepository=i,this._rctx=a,this._compositingHelper=n,this._magnifierHelper=l,this._requestRender=p,this._pluginsHas={hudElements:!1,water:!1},this._hasOverlayWater=!1,this.renderOverlay=e=>{},this._isRendering=!1,this._backgroundColor=A(0,0,0,1),this._sliceHelper=new ie,this._state=_(pe.IDLE),this._highQualityTransparencyEnabled=!0,this._terrainTransparency=P.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new U,this._reprojectionMatrixVersion=_(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new Map,this._releaseNormals=e=>{e.find((({name:e})=>"normals"===e))?.release()&&this._pluginInput.delete("normals")},this._debugLinearDepth=!1,this.fboCache=new I(a),this._renderStateFeatures=_(Z(!has("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._offscreen=new X(this.fboCache,this._compositingHelper),this.performanceInfo=new le(this._rctx),this._shadowMap=new te(this.fboCache,e.viewingMode),this._highlight=new M({view:e.view}),this._shadowHighlight=new x({view:e.view,viewingMode:e.viewingMode}),this._shadowAccumulator=new re(this.fboCache,i,e,(e=>{const r=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=r}),((e,r,t)=>{const s=this._stage.view.qualitySettings.maximumPixelRatio;e.shadowMap.start(e.camera,r,t,!0,s),this._renderShadowCascades(w.Shadow,e.shadowMap),e.shadowMap.finish(),e.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(e.camera,e.contentCamera)}),p),this._ssao=new F({view:this._stage.view}),this._renderContext=new Y(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._nodes=new D(this._renderContext),this._plugins=new L({renderContext:this._renderContext,techniqueRepository:i,textureRepository:s,materialRepository:r,requestRender:p,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this.renderPassManager=new O,this._plugins.add(this.renderPassManager),this._smaa=new v({view:this._stage.view}),this._plugins.add(this._smaa),this._blit=new H({opacity:1,alphaMode:de.None}),this._plugins.add(this._blit),this._plugins.add(this._ssao),this._plugins.add(this._highlight),this._plugins.add(this._shadowHighlight),this._handles=[h((()=>this._stage.view.state.camera),(()=>p()),o),h((()=>R.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(he.TRANSPARENT):()=>{},p()}),d),h((()=>this._stage.view.environment.background?.color),(e=>{const r=e?t(e):E;T(this._backgroundColor,r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),p()}),o)]}destroy(){this._handles.forEach((e=>e.remove())),this._gpuTimerHandle=s(this._gpuTimerHandle),this._nodes.destroy(),this._offscreen.dispose(),this._shadowMap.dispose(),this._highlight.dispose(),this._shadowAccumulator.dispose(),this._edgeView=i(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),B.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(e=null,r=!has("disable-feature:high-quality-idle")){this._renderStateFeatures.value=Z(r,e),this._plugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e,r=this._state.value){return this._renderStateFeatures.value.get(r,e)??!1}setFeatureEnabled(e,r,t){this._renderStateFeatures.mutate((s=>s.set(r,e,t))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled($.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled($.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations}get hasHighlights(){return this._plugins.produces(ee.OPAQUE_MATERIAL,w.Highlight)||this._plugins.produces(ee.TRANSPARENT_MATERIAL,w.Highlight)||this._plugins.produces(ee.DRAPED_MATERIAL,w.Highlight)}get _magnifierEnabled(){return this._bindParameters.decorations===q.ON&&this._magnifierHelper.enabled}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled($.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=a(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.linearDepth=a(this._bindParameters.multipassTerrain.linearDepth),this._bindParameters.multipassGeometry.linearDepth=a(this._bindParameters.multipassGeometry.linearDepth)}_disposeOffscreenBuffers(){this._offscreen.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.linearDepth=a(this._bindParameters.linearDepth),this._bindParameters.hudVisibility=a(this._bindParameters.hudVisibility)}get updating(){return this._smaa.updating||null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}ensureEdgeView(){if(null==this._edgeView){const e=this._stage.view.resourceController;this._edgeView=new ne({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:Ce(e)}),this._handles.push(h((()=>this._edgeView?.updating),(()=>this._requestRender()),l)),this._requestRender()}return this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&u(this._bindParameters.ssr.reprojectionMatrix,g)}set _reprojectionMatrix(e){r(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:r,_bindParameters:t}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&r.maxCascades!==e.shadowMapMaxCascades&&(r.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const r="virtual"!==e.environment.lighting.type;t.enableFillLights!==r&&(t.enableFillLights=r,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,r){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:s,updates:i}=e;if(0===t.length&&0===s.length&&0===i.length)return;const a=J(e);let n=!1;a.forEach(((t,s)=>{if(r.done)return;let i=this._plugins.getMaterialRenderer(s);if(null==i&&t.adds.length>0){const e=new oe({material:s});e.initializeRenderContext(this._plugins._context),i=e,this._plugins.add(i)}i&&(i.modify(t),0===i.numGeometries&&(n=!0)),t.removes.forEach((r=>e.removes.removeUnordered(r))),t.adds.forEach((r=>e.adds.removeUnordered(r))),t.updates.forEach((r=>e.updates.removeUnordered(r))),r.madeProgress()})),n&&this._plugins.removeEmptyMaterialRenderers(),this._updateHasFlags(),this._requestRender()}_updateHasFlags(){const has=this._pluginsHas;has.hudElements=this._plugins.produces(ee.LINE_CALLOUTS_HUD_DEPTH)||this._plugins.produces(ee.HUD_MATERIAL)||this._plugins.produces(ee.LABEL_MATERIAL),has.water=this._plugins.produces(ee.DRAPED_WATER,w.Normal),this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(e){const r=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(e),this._hasAnimations=this._nodes.updateAnimation()||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?s(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,r,t=K.Default,s=q.ON){this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frameStart(),this._disposeBindBuffers();const i=this._offscreen,{camera:n,contentCamera:h,mode:o,alignPixelEnabled:d}=e;this._state.value=o,this._bindParameters.overlay=this.renderOverlay(r),this.performanceInfo.advance(_e.OVERLAY),this._renderContext.time=r,this._bindParameters.transparencyPassType=ae.NONE,this._bindParameters.alignPixelEnabled=d,this._bindParameters.decorations=s,this._bindParameters.mainColor=this._bindParameters.mainDepth=null;const l=b(this._sliceHelper.plane);s===q.OFF&&(this._sliceHelper.plane=null),n.setGLViewport(this._rctx);const _=i.initializeFrame(n,this._backgroundColor,t);this.hasReflections?this._bindParameters.ssr.lastFrameColor=_:_?.release(),this._ensureBindParametersCamera(n,h),this._plugins.prepareRender(),this.performanceInfo.advance(_e.PREPARE);const p=this._computeDepthRange(n);this._renderShadowMap(n,this._bindParameters.lighting.mainLight.direction,p),this.performanceInfo.advance(_e.SHADOW_MAP),this._ensureBindParametersCamera(n,h);const u=this._plugins.produces(ee.OPAQUE_TERRAIN)&&(this._terrainTransparency===P.Semitransparent||this._terrainTransparency===P.TransparentWithDraped),c=this._highQualityTransparency&&u,m=this._plugins.produces(ee.TRANSPARENT_MATERIAL,w.Color);this._prepareShaders(c,m),this._pluginInput.set("normals",this._renderNormals()),this.performanceInfo.advance(_e.NORMALS),this._renderSSAO(),this.performanceInfo.advance(_e.SSAO),this._renderLinearDepth(),this.performanceInfo.advance(_e.LINEAR_DEPTH),this._renderShadowAccumulation(p,n,h),this.performanceInfo.advance(_e.ACCUMULATED_SHADOWS),this._ensureBindParametersSSR(r),this._renderContext.output=w.Color,i.bindFbo(),this._bindParameters.mainColor=i.colorTexture,this._bindParameters.mainDepth=i.depthTexture,this._renderOpaqueGeometry(),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"opaque-color"),this._plugins.render(ee.ENVIRONMENT_OPAQUE),this.performanceInfo.advance(_e.OPAQUE),this.fboCache.debugCallback&&this.fboCache.debugCallback("opaque-color",this._offscreen.color.fbo),this._renderTerrainLinearDepth(c),this._setMultipassTerrain(c),this._renderEdges(he.OPAQUE),this.performanceInfo.advance(_e.OPAQUE_EDGES),i.bindFbo(),this._plugins.render(ee.VOXEL),this.performanceInfo.advance(_e.VOXEL),this._renderHiddenTransparentEdges(),m&&(this._oitEnabled?this._renderOITPass(Te.Geometry):this._renderTransparentMaterial()),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"transparent-color"),this.performanceInfo.advance(_e.TRANSPARENT);const g=this._renderGeometryLinearDepth(c);this._renderHUDVisibility(g),c||this._plugins.render(ee.LINE_CALLOUTS),this.performanceInfo.advance(_e.HUD_VISIBILITY);const f=t===K.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this.performanceInfo.advance(_e.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(he.TRANSPARENT,g),g?.release(),this.performanceInfo.advance(_e.TRANSPARENT_EDGES);const T=u?this._renderTransparentTerrain():null;T&&this._bindParameters.hudVisibility&&(c?this._renderLineCallouts(y.Occluded):i.compositeToHUDVisibility(this._bindParameters,T.getTexture()),this._renderHUD(y.Occluded,i.color),this.performanceInfo.advance(_e.HUD_OCCLUDED)),this.performanceInfo.advance(_e.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),T&&(i.compositeToFramebuffer(this._bindParameters,T.getTexture(),de.PremultipliedAlpha,1),T.release(),c&&(this._renderEdges(he.OPAQUE),this.performanceInfo.advance(_e.OPAQUE_EDGES),m&&(this._oitEnabled?this._renderOITPass(Te.Geometry):this._renderTransparentMaterial()),this.performanceInfo.advance(_e.TRANSPARENT),this._renderEdges(he.TRANSPARENT),this.performanceInfo.advance(_e.TRANSPARENT_EDGES))),this._bindParameters.ssao=a(this._bindParameters.ssao),c&&this._renderLineCallouts(y.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),i.bindFbo(),this._plugins.render(ee.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.render(ee.ENVIRONMENT_TRANSPARENT),this.performanceInfo.advance(_e.ENVIRONMENT),this._renderLaserlines(),this.performanceInfo.advance(_e.LASER_LINES),this._renderOccluded(),this.performanceInfo.advance(_e.OCCLUDED);let A=this._renderHighlightPrepass();A&&this._renderShadowHighlights(A,this._bindParameters);const E=this._magnifierEnabled&&t===K.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"magnifier"):null,R=t!==K.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"screenshot"):null,S=this._renderComposite(E??R,A)??R;return this.performanceInfo.advance(_e.ANTIALIASING),this._renderHUD(y.NotOccluded,S),this.performanceInfo.advance(_e.HUD),A&&(this._renderHighlights(S,A,this._bindParameters),A=a(A)),this.performanceInfo.advance(_e.HIGHLIGHTS),this._magnifierEnabled&&this._magnifierHelper.render(this._rctx,this._bindParameters),S!==R&&(this._rctx.bindFramebuffer(R?.fbo),this._compositingHelper.composite(this._bindParameters,E?.getTexture(),de.None)),t===K.Default&&E?.release(),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=l,this._isRendering=!1,this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),t!==K.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),{screen:R,oid:f}}_prepareShaders(e,r){this._renderContext.output=w.Color,this._prepareOpaqueGeometry(),this._setMultipassTerrain(e),this._plugins.prepare(ee.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._plugins.prepare(ee.LINE_CALLOUTS),r&&this._prepareTransparencySlots(),this._plugins.prepare(ee.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.prepare(ee.ENVIRONMENT_TRANSPARENT),this._plugins.prepare(ee.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(!has("enable-feature:objectAndLayerId-rendering"))return;const e=this._renderContext.output,r=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");return r.acquireDepth(S.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(r.fbo),this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0),this._renderAllGeometry(w.ObjectAndLayerIdColor),this._rctx.bindFramebuffer(r.fbo),this.fboCache.rctx.clearFramebuffer(void 0,!0,!0),this._bindParameters.hudRenderStyle=y.NotOccluded,this._plugins.render(ee.HUD_MATERIAL),this._renderContext.output=e,r}finish(e){this._hasAnimations||this._animationTimestep.clear();const r=this.performanceInfo.gpuSamplingEnabled,t=e===j.BACKGROUND;if(t||r){const e=t?this.performanceInfo.elapsedTime:0,s=r?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),i=Math.max(e,s);this._animationTimestep.frame(i,t)}}readDepthPixels(e,r,t){const s=this._bindParameters.linearDepth?.fbo;if(s?.colorTexture)return void s.readPixels(r[0],r[1],r[2],r[3],ue.RGBA,ce.UNSIGNED_BYTE,t);const i=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"depth").acquireDepth(S.DEPTH16_BUFFER);this._rctx.bindFramebuffer(i.fbo),this._ensureBindParametersCamera(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const a=me.COLOR_BUFFER_BIT|me.DEPTH_BUFFER_BIT|me.STENCIL_BUFFER_BIT;this._rctx.clearSafe(a),this._renderAllGeometry(w.LinearDepth),i.fbo.readPixels(r[0],r[1],r[2],r[3],ue.RGBA,ce.UNSIGNED_BYTE,t),i.release()}readHUDVisibility(e,r,t,s,i){this._bindParameters.hudVisibility?.fbo.readPixels(e,r,t,s,ue.RGBA,ce.UNSIGNED_BYTE,i)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassEnabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderEdges(e,r){const t=this._edgeView;if(t?.shouldRender()){const{width:s,height:i,depth:a}=this._offscreen,n=this.fboCache.acquire(s,i,"edges"),h=()=>t.render(this._bindParameters,e);this._offscreen.renderToTargets(h,n,r??a,Ee),this._offscreen.compositeToFramebuffer(this._bindParameters,n.getTexture(),de.Alpha,1),n.release()}}_renderShadowMap(e,r,t){const s=this._shadowMap;s.enabled&&(s.start(e,r,t,this.isFeatureEnabled($.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(e,r),this._needsShadowHighlight?(this._renderShadowCascades(w.ShadowHighlight,this._shadowMap),s.moveSnapshot(se.Highlight),this._renderShadowCascades(w.ShadowExcludeHighlight,this._shadowMap),s.copySnapshot(se.ExcludeHighlight),this._renderShadowCascades(w.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(w.Shadow),s.finish(),e.setGLViewport(this._rctx))}_renderShadowCascades(e,r=this._shadowMap){for(const t of r.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._renderAllGeometry(e)}get _needsLinearDepth(){return this._plugins.consumes(w.LinearDepth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugLinearDepth}_renderLinearDepth(){this._needsLinearDepth?(this._bindParameters.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.linearDepth,"linear-depth",(()=>this._renderAllGeometry(w.LinearDepth)),[0,0,0,0],C.RGBA,S.DEPTH_STENCIL_TEXTURE),this._bindParameters.linearDepth.detachDepth()):this._bindParameters.linearDepth=a(this._bindParameters.linearDepth)}_renderTerrainLinearDepth(e){if(e){const e=this._renderContext.output;this._renderContext.output=w.LinearDepth,this._bindParameters.multipassTerrain.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassTerrain.linearDepth,"terrain depth",(()=>this._renderTransparentTerrain()),[-1e10,-1e10,-1e10,1]),this._bindParameters.multipassTerrain.linearDepth.detachDepth(),this._renderContext.output=e}else this._bindParameters.multipassTerrain.linearDepth=a(this._bindParameters.multipassTerrain.linearDepth)}_renderGeometryLinearDepth(e){if(!e)return void(this._bindParameters.multipassGeometry.linearDepth=a(this._bindParameters.multipassGeometry.linearDepth));const r=this._renderContext.output;this._bindParameters.multipassGeometry.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassGeometry.linearDepth,"geometry depth",(()=>this._renderOpaqueGeometryAndTransparentMaterial(w.LinearDepth)),[1,1,1,1]),this._renderContext.output=r;const t=this._bindParameters.multipassGeometry.linearDepth.getAttachment(ge);return t?.retain(),this._bindParameters.multipassGeometry.linearDepth.detachDepth(),t}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return V;const r=k(e,this._plugins.plugins,this._stage.layers);return Q(r,this._plugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r}_renderNormals(){const e=this._plugins.produces(ee.SSAO),r=this._nodes.require("normals","composite-color")+this._nodes.require("normals","opaque-color")+this._nodes.require("normals","transparent-color");let t=(e?1:0)+r+(e||r>0?this._nodes.optional("normals","composite-color")+this._nodes.optional("normals","opaque-color")+this._nodes.optional("normals","transparent-color"):0);if(0===t)return;const s=this._offscreen.renderToCachedFBO(null,"normals",(()=>this._renderGeometryForSSAO(w.Normal)),[0,0,0,0],C.RGBA,S.DEPTH_STENCIL_TEXTURE);for(;--t>0;)s.retain();return s}_renderSSAO(){const e=this._pluginInput.get("normals");this._plugins.produces(ee.SSAO)&&e&&(this._bindParameters.ssao=this._plugins.render(ee.SSAO,this._pluginInput),e.detachDepth(),e.release()&&this._pluginInput.delete("normals"))}_renderAllGeometry(e){this._renderContext.output=e,this._plugins.prepare(ee.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(e){this._renderContext.output=e,this._plugins.prepare(ee.TRANSPARENT_MATERIAL),this._plugins.prepare(ee.TRANSPARENT_NO_SSAO_DEPTH),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}_renderGeometryForSSAO(e){this._renderContext.output=e,this._plugins.render(ee.INTEGRATED_MESH),this._plugins.render(ee.OPAQUE_TERRAIN),this._plugins.render(ee.OPAQUE_MATERIAL),this._plugins.render(ee.TRANSPARENT_MATERIAL),this._renderTransparentTerrain()}_prepareOpaqueGeometry(){this._plugins.prepare(ee.INTEGRATED_MESH),this._plugins.prepare(ee.OPAQUE_TERRAIN),this._plugins.prepare(ee.OPAQUE_MATERIAL),this._plugins.prepare(ee.OPAQUE_NO_SSAO_DEPTH),this._plugins.prepare(ee.ENVIRONMENT_OPAQUE)}_renderOpaqueGeometry(){this._plugins.render(ee.INTEGRATED_MESH),this._plugins.render(ee.OPAQUE_TERRAIN),this._plugins.render(ee.OPAQUE_MATERIAL),this._plugins.render(ee.OPAQUE_NO_SSAO_DEPTH)}_renderTransparentMaterial(){this._plugins.render(ee.TRANSPARENT_MATERIAL),this._plugins.render(ee.TRANSPARENT_NO_SSAO_DEPTH)}_renderTransparentTerrain(){if(!this._plugins.produces(ee.TRANSPARENT_TERRAIN))return;const e=()=>this._plugins.render(ee.TRANSPARENT_TERRAIN,null);if(this._renderContext.output!==w.Color)return void e();const{width:r,height:t,depth:s}=this._offscreen,i=this.fboCache.acquire(r,t,"transparent terrain");return this._offscreen.renderToTargets(e,i,s,[0,0,0,0]),i}_renderHUDVisibility(e){this._plugins.produces(ee.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,(()=>this._plugins.render(ee.OCCLUSION_PIXELS)),e),this._offscreen.bindFbo()):this._bindParameters.hudVisibility=a(this._bindParameters.hudVisibility)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===y.Occluded){const e=()=>{this._plugins.render(ee.LINE_CALLOUTS)},{width:r,height:t,color:s}=this._offscreen,i=this.fboCache.acquireDepth(S.DEPTH16_BUFFER,r,t,"line callouts");this._offscreen.renderToTargets(e,s,i,void 0,!0,!0),i.release()}else this._plugins.render(ee.LINE_CALLOUTS)}_renderLaserlines(){if(this._plugins.render(ee.LASERLINES),this._plugins.produces(ee.LASERLINES_CONTRAST_CONTROL)){const e=this._offscreen,{width:r,height:t,depth:s}=e,i=this.fboCache.acquire(r,t,"laser lines"),a=()=>this._plugins.render(ee.LASERLINES_CONTRAST_CONTROL);e.renderToTargets(a,i,s,Ee),e.compositeToFramebuffer(this._bindParameters,i.getTexture(),de.PremultipliedAlpha,1),i.release()}}_renderHUD(e,r){if(this._pluginsHas.hudElements)if(this._oitEnabled){const t=this._renderOITPass(Te.HUD,e);this._rctx.bindFramebuffer(r?.fbo),this._compositingHelper.composite(this._bindParameters,t.getTexture(),de.PremultipliedAlpha),t.release()}else if(e===y.Occluded){this._renderContext.output=w.Color;const r=()=>this._renderHUDElements(e),{width:t,height:s,color:i}=this._offscreen,a=this.fboCache.acquireDepth(S.DEPTH16_BUFFER,t,s,"hud");this._offscreen.renderToTargets(r,i,a,void 0,!0,!0),a.release()}else this._renderContext.output=w.Color,this._rctx.bindFramebuffer(null),r?.acquireDepth(S.DEPTH16_BUFFER),this._rctx.bindFramebuffer(r?.fbo),this._renderHUDElements(e),r?.detachDepth()}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.prepare(ee.LINE_CALLOUTS_HUD_DEPTH),this._plugins.prepare(ee.HUD_MATERIAL),this._plugins.prepare(ee.LABEL_MATERIAL),this._plugins.render(ee.LINE_CALLOUTS_HUD_DEPTH),this._plugins.render(ee.HUD_MATERIAL),this._plugins.render(ee.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(ee.SHADOW_HIGHLIGHT)&&this._plugins.produces(ee.OPAQUE_MATERIAL,w.ShadowHighlight)}_renderHighlightPrepass(){if(!this.hasHighlights)return;const e=()=>{this._renderAllGeometry(w.Highlight),this._rctx.clearSafe(me.DEPTH_BUFFER_BIT),this._renderHUDElements(y.Both)},r=this._offscreen.renderToCachedFBO(null,"highlights",e,[0,0,0,0],C.RGBA4,S.DEPTH_STENCIL_TEXTURE);return r.detachDepth(),r}_renderShadowHighlights(e,r){this.hasHighlights&&r.decorations!==q.OFF&&this._needsShadowHighlight&&this._offscreen.updateColor((r=>(this._pluginInput.set("highlights",e),this._plugins.render(ee.SHADOW_HIGHLIGHT,this._pluginInput,r),r)),"transparent-color")}_renderHighlights(e,r,t){this.hasHighlights&&t.decorations!==q.OFF&&this._plugins.produces(ee.HIGHLIGHT)&&(this._pluginInput.set("highlights",r),this._plugins.render(ee.HIGHLIGHT,this._pluginInput,e))}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,r,t){this._needsShadowCast&&this._bindParameters.linearDepth?.getTexture()&&this._shadowAccumulator.renderAccumulation(this._bindParameters.linearDepth,e,r,t)}_prepareTransparencySlots(){this._renderContext.output=w.Alpha,this._bindParameters.transparencyPassType=ae.Alpha,this._plugins.prepare(ee.TRANSPARENT_MATERIAL),this._renderContext.output=w.Color,this._bindParameters.transparencyPassType=ae.Color,this._plugins.prepare(ee.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=ae.FrontFace,this._plugins.prepare(ee.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=ae.NONE}_renderOITPass(e,r=y.Both){const t=e===Te.HUD,s=t?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null,i=t?()=>this._renderHUDElements(r):()=>this._renderTransparentMaterial(),a=this._renderContext.output;this._renderContext.output=w.Alpha,this._bindParameters.transparencyPassType=ae.Alpha;const n=this._offscreen.renderOITPass(i,ae.Alpha,t);this._renderContext.output=w.Color,this._bindParameters.transparencyPassType=ae.Color;const h=this._offscreen.renderOITPass(i,ae.Color,t);this._bindParameters.transparencyPassType=ae.FrontFace;const o=this._offscreen.renderOITPass(i,ae.FrontFace,t);return this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,h,n,o,s),s?.detachDepth(),o.release(),h.release(),n.release(),this._bindParameters.transparencyPassType=ae.NONE,this._renderContext.output=a,s}_renderOccluded(){let e=0;be.clear(),this._plugins.plugins.forAll((r=>{if(!r.materialReference)return;r.queryRenderOccludedState(W.OccludeAndTransparentStencil)&&(e|=W.OccludeAndTransparentStencil,be.push(r))}));const r=this._offscreen,t=(t,s,i,a,n)=>{if(0==(e&s))return;const{width:h,height:o,depth:d}=r,l=this.fboCache.acquire(h,o,"tmp color");r.renderToTargets(i,l,d,[0,0,0,0],a,n),r.compositeToFramebuffer(this._bindParameters,l.getTexture(),de.PremultipliedAlpha,t),l.release()},s=(e,r)=>{this._bindParameters.slot=e,r.forAll((e=>{if(N(e)){const r=e.prepareTechnique(this._renderContext);r&&e.renderNode(this._renderContext,r)}}))};0!==be.length&&(s(ee.OCCLUDER_MATERIAL,be),t(.5,W.OccludeAndTransparentStencil,(()=>s(ee.TRANSPARENT_OCCLUDER_MATERIAL,be)),!1,!1)),be.clear(),this._plugins.plugins.forAll((r=>{if(!r.materialReference)return;const t=r.queryRenderOccludedState(W.OccludeAndTransparent),s=r.queryRenderOccludedState(W.Transparent),i=r.queryRenderOccludedState(W.Opaque);(t||s||i)&&(e|=t?W.OccludeAndTransparent:s?W.Transparent:W.Opaque,be.push(r))}));const i=this._plugins.renderOccludedFlags;if(e|=i,!e)return;const a=e=>{this._renderContext.renderOccludedMask=e,i>W.Occlude&&this._plugins.render(ee.OCCLUDED_TERRAIN),s(ee.OPAQUE_MATERIAL,be),s(ee.TRANSPARENT_MATERIAL,be),s(ee.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,be),this._renderContext.renderOccludedMask=z};this._renderContext.output=w.Color,t(.5,W.OccludeAndTransparent,(()=>a(W.OccludeAndTransparent)),!0,G.OutlineVisualElementMask),t(.5,W.Transparent,(()=>a(W.Transparent)),!0,G.OutlineVisualElementMask),t(1,W.Opaque,(()=>a(W.Opaque)),!0,G.OutlineVisualElementMask),be.clear()}_invokeRenderNodes(e){return this._nodes.render(e,this._pluginInput,this._releaseNormals)}_renderComposite(e,r){this._offscreen.updateColor((e=>(this._pluginInput.set("highlights",r),e=this._nodes.render(e,this._pluginInput,this._releaseNormals),this._pluginInput.set(e.name,e),this._pluginInput.delete("highlights"),e)),"composite-color");const t=this._plugins.produces(ee.ANTIALIASING);return this._plugins.render(t?ee.ANTIALIASING:ee.BLIT,this._pluginInput,e)}_ensureBindParametersCamera(e,r){this._bindParameters.camera=e,this._bindParameters.contentCamera=r}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=g:(c(Pe,this._bindParameters.camera.viewMatrix),c(Re,this._bindParameters.camera.projectionMatrix),m(Se,Pe,Re),m(Se,this._renderContext.lastFrameCamera.viewMatrix,Se),m(Se,this._renderContext.lastFrameCamera.projectionMatrix,Se),this._reprojectionMatrix=Se);const r=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=r>0?Math.min(r,e-this._ssrEnableTime)/r:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=g,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}get test(){return{offscreen:this._offscreen,shadowMap:this._shadowMap,highlight:this._highlight,lighting:this._bindParameters.lighting,renderPlugins:this._plugins,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{this._renderStateFeatures.value=Z(),this._plugins.renderFeatureChanged(),this._requestRender()},getFramebufferTexture:e=>{switch(e){case Ae.Color:return this._offscreen.colorTexture;case Ae.LinearDepth:return this._bindParameters.linearDepth?.getTexture();case Ae.ShadowMap:return this._shadowMap.depthTexture;case Ae.HudVisibility:return this._bindParameters.hudVisibility?.getTexture()}},debugLinearDepth:e=>{this._debugLinearDepth=e,this._requestRender()}}}}var Te,Ae;e([p({readOnly:!0})],fe.prototype,"fullResolutionAtmosphere",null),e([p()],fe.prototype,"_smaa",void 0),e([p()],fe.prototype,"_blit",void 0),e([p()],fe.prototype,"_edgeView",void 0),e([p()],fe.prototype,"updating",null),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(Te||(Te={})),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.ShadowMap=2]="ShadowMap",e[e.HudVisibility=3]="HudVisibility"}(Ae||(Ae={}));const Ee=[0,0,0,0],be=new n,Re=f(),Pe=f(),Se=f();function Ce(e){return r=>e.immediate.schedule(r)}export{Ae as FramebufferId,fe as Renderer};
