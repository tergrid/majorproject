/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import has from"../../../../core/has.js";import{fromValues as e}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{BufferViewMat3f as t,BufferViewVec4f as r}from"../../../../geometry/support/buffer/BufferView.js";import{newLayout as s}from"../../support/buffer/InterleavedLayout.js";import{isOIDorHighlight as i,isColorOrAlpha as a,ShaderOutput as o}from"../core/shaderLibrary/ShaderOutput.js";import{CullFaceOptions as n}from"../lib/basicInterfaces.js";import c from"../lib/GLMaterial.js";import{OITPolygonOffsetLimit as l}from"../lib/OrderIndependentTransparency.js";import{RenderSlot as u}from"../lib/RenderSlot.js";import{assert as h}from"../lib/Util.js";import{VertexAttribute as p}from"../lib/VertexAttribute.js";import{DefaultBufferWriter as f}from"./DefaultBufferWriter.js";import{Style as m}from"./PatternStyle.js";import{TriangleMaterial as d}from"./TriangleMaterial.js";import{VisualVariablePassParameters as g}from"./VisualVariablePassParameters.js";import{writeDefaultAttributes as _,writeBufferVec4 as b}from"./internal/bufferWriterUtils.js";import{vertexAttributeLocationsOID as A,vertexAttributeLocations as O,PatternTechniqueConfiguration as T,PatternTechnique as y}from"../shaders/PatternTechnique.js";class P extends d{constructor(e){super(e,new S),this.supportsEdges=!0,this.produces=new Map([[u.OPAQUE_MATERIAL,e=>i(e)],[u.TRANSPARENT_MATERIAL,e=>a(e)],[u.TRANSPARENT_NO_SSAO_DEPTH,e=>e===o.LinearDepth&&this.parameters.writeLinearDepth],[u.DRAPED_MATERIAL,e=>this.parameters.draped&&e===o.Color||i(e)]]),this._vertexAttributeLocations=has("enable-feature:objectAndLayerId-rendering")?A:O,this._configuration=new T}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<l,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}createGLMaterial(e){return new v(e)}createBufferWriter(){const e=s().vec3f(p.POSITION).vec4f(p.UVMAPSPACE);return this.parameters.draped||e.mat3f(p.BOUNDINGRECT),this.parameters.vvColor?e.f32(p.COLORFEATUREATTRIBUTE):e.vec4u8(p.COLOR),has("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(p.OBJECTANDLAYERIDCOLOR),new E(e)}}class v extends c{_updateParameters(e){return this.ensureTechnique(y,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==o.Color&&this._output!==o.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class E extends f{write(e,s,i,a,o){_(i,this.vertexBufferLayout,e,s,a,o);for(const n of this.vertexBufferLayout.fields.keys()){const s=i.attributes.get(n),c=s?.indices;if(s&&c)switch(n){case p.UVMAPSPACE:{h(4===s.size);const e=a.getField(n,r);e&&b(s,e,o);break}case p.BOUNDINGRECT:{h(9===s.size);const r=a.getField(n,t);r&&this.writeBoundingRect(s,e,r,o);break}}}}writeBoundingRect(e,t,r,s){const{data:i,indices:a}=e,o=t,n=r.typedBuffer,c=r.typedBufferStride,l=a.length;s*=c;for(let u=0;u<l;++u){const e=9*a[u],t=i[e],r=i[e+1],l=i[e+2];n[s]=o[0]*t+o[4]*r+o[8]*l+o[12],n[s+1]=o[1]*t+o[5]*r+o[9]*l+o[13],n[s+2]=o[2]*t+o[6]*r+o[10]*l+o[14];for(let a=3;a<9;++a)n[s+a]=i[e+a];s+=c}}}class S extends g{constructor(){super(...arguments),this.color=e(1,1,1,1),this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=n.None,this.hasOccludees=!1,this.style=m.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}}export{S as Parameters,P as PatternMaterial};
