/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{update as t}from"../../../../../core/arrayUtils.js";import{clamp as n}from"../../../../../core/mathUtils.js";import{s as e,b as i,n as o}from"../../../../../chunks/vec32.js";import{create as r}from"../../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{create as s,setMin as c,setMax as l}from"../../../../../geometry/support/aaBoundingBox.js";import{ContentObjectType as f}from"../../lib/ContentObjectType.js";import{scale as a}from"../../lib/screenSizePerspectiveUtils.js";import{assert as u}from"../../lib/Util.js";import{VertexAttribute as m}from"../../lib/VertexAttribute.js";const p=s();function h(t,n,e,i,o,r){if(t.visible)if(t.boundingInfo){u(t.type===f.Mesh);const s=n.tolerance;x(t.boundingInfo,e,i,s,o,r)}else{const n=t.attributes.get(m.POSITION),s=n.indices;g(e,i,0,s.length/3,s,n,void 0,o,r)}}const b=r();function x(t,n,e,i,o,r){if(null==t)return;const s=T(n,e,b);if(c(p,t.bbMin),l(p,t.bbMax),null!=o&&o.applyToAabb(p),I(p,n,s,i)){const{primitiveIndices:s,position:c}=t,l=s?s.length:c.indices.length/3;if(l>P){const s=t.getChildren();if(void 0!==s){for(const t of s)x(t,n,e,i,o,r);return}}g(n,e,0,l,c.indices,c,s,o,r)}}const d=r();function g(t,n,e,i,o,r,s,c,l){if(s)return M(t,n,e,i,o,r,s,c,l);const{data:f,stride:a}=r,u=t[0],m=t[1],p=t[2],h=n[0]-u,b=n[1]-m,x=n[2]-p;for(let g=e,M=3*e;g<i;++g){let t=a*o[M++],n=f[t++],e=f[t++],i=f[t];t=a*o[M++];let r=f[t++],s=f[t++],y=f[t];t=a*o[M++];let j=f[t++],T=f[t++],I=f[t];null!=c&&([n,e,i]=c.applyToVertex(n,e,i,g),[r,s,y]=c.applyToVertex(r,s,y,g),[j,T,I]=c.applyToVertex(j,T,I,g));const V=r-n,L=s-e,N=y-i,O=j-n,A=T-e,E=I-i,P=b*E-A*x,S=x*O-E*h,U=h*A-O*b,W=V*P+L*S+N*U;if(Math.abs(W)<=Number.EPSILON)continue;const B=u-n,C=m-e,k=p-i,z=B*P+C*S+k*U;if(W>0){if(z<0||z>W)continue}else if(z>0||z<W)continue;const H=C*N-L*k,R=k*V-N*B,Y=B*L-V*C,q=h*H+b*R+x*Y;if(W>0){if(q<0||z+q>W)continue}else if(q>0||z+q<W)continue;const w=(O*H+A*R+E*Y)/W;if(w>=0){l(w,v(V,L,N,O,A,E,d),g,!1)}}}function M(t,n,e,i,o,r,s,c,l){const{data:f,stride:a}=r,u=t[0],m=t[1],p=t[2],h=n[0]-u,b=n[1]-m,x=n[2]-p;for(let g=e;g<i;++g){const t=s[g];let n=3*t,e=a*o[n++],i=f[e++],r=f[e++],M=f[e];e=a*o[n++];let y=f[e++],j=f[e++],T=f[e];e=a*o[n];let I=f[e++],V=f[e++],L=f[e];null!=c&&([i,r,M]=c.applyToVertex(i,r,M,g),[y,j,T]=c.applyToVertex(y,j,T,g),[I,V,L]=c.applyToVertex(I,V,L,g));const N=y-i,O=j-r,A=T-M,E=I-i,P=V-r,S=L-M,U=b*S-P*x,W=x*E-S*h,B=h*P-E*b,C=N*U+O*W+A*B;if(Math.abs(C)<=Number.EPSILON)continue;const k=u-i,z=m-r,H=p-M,R=k*U+z*W+H*B;if(C>0){if(R<0||R>C)continue}else if(R>0||R<C)continue;const Y=z*A-O*H,q=H*N-A*k,w=k*O-N*z,D=h*Y+b*q+x*w;if(C>0){if(D<0||R+D>C)continue}else if(D>0||R+D<C)continue;const F=(E*Y+P*q+S*w)/C;if(F>=0){l(F,v(N,O,A,E,P,S,d),t,!1)}}}const y=r(),j=r();function v(t,n,r,s,c,l,f){return e(y,t,n,r),e(j,s,c,l),i(f,y,j),o(f,f),f}function T(t,n,i){return e(i,1/(n[0]-t[0]),1/(n[1]-t[1]),1/(n[2]-t[2]))}function I(t,n,e,i){return V(t,n,e,i,1/0)}function V(t,n,e,i,o){const r=(t[0]-i-n[0])*e[0],s=(t[3]+i-n[0])*e[0];let c=Math.min(r,s),l=Math.max(r,s);const f=(t[1]-i-n[1])*e[1],a=(t[4]+i-n[1])*e[1];if(l=Math.min(l,Math.max(f,a)),l<0)return!1;if(c=Math.max(c,Math.min(f,a)),c>l)return!1;const u=(t[2]-i-n[2])*e[2],m=(t[5]+i-n[2])*e[2];return l=Math.min(l,Math.max(u,m)),!(l<0)&&(c=Math.max(c,Math.min(u,m)),!(c>l)&&c<o)}function L(t,e,i,o,r){let s=(i.screenLength||0)*t.pixelRatio;null!=r&&(s=a(s,o,e,r));const c=s*Math.tan(.5*t.fovY)/(.5*t.fullHeight);return n(c*e,i.minWorldLength||0,null!=i.maxWorldLength?i.maxWorldLength:1/0)}function N(t,n){const e=n?N(n):{};for(const i in t){let n=t[i];n?.forEach&&(n=A(n)),null==n&&i in e||(e[i]=n)}return e}function O(n,e){let i=!1;for(const o in e){const r=e[o];void 0!==r&&(Array.isArray(r)?null===n[o]?(n[o]=r.slice(),i=!0):t(n[o],r)&&(i=!0):n[o]!==r&&(i=!0,n[o]=r))}return i}function A(t){const n=[];return t.forEach((t=>n.push(t))),n}const E={multiply:1,ignore:2,replace:3,tint:4},P=1e3;export{E as colorMixModes,T as computeInvDir,v as computeNormal,N as copyParameters,I as intersectAabbInvDir,V as intersectAabbInvDirBefore,h as intersectTriangleGeometry,g as intersectTriangles,O as updateParameters,L as verticalOffsetAtDistance};
