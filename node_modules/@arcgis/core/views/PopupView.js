/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as p}from"../chunks/tslib.es6.js";import{createTask as e}from"../core/asyncUtils.js";import{deprecated as t}from"../core/deprecate.js";import o from"../core/Error.js";import has from"../core/has.js";import i from"../core/Logger.js";import{throwIfAborted as s,wrapAbortWithTimeout as r,allSettledValues as a,createResolver as n}from"../core/promiseUtils.js";import{watch as u,initial as c,whenOnce as l}from"../core/reactiveUtils.js";import{property as h}from"../core/accessorSupport/decorators/property.js";import"../core/RandomLCG.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import{ViewEventPriorities as w}from"./input/InputManager.js";function m(p){return null!=p&&"open"in p&&"declaredClass"in p}function f(p){return null!=p&&"declaredClass"in p&&"dockOptions"in p}const y=n=>{let y=class extends n{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([u((()=>[this.ui,this.popup]),(([p,e],t)=>{const o="popup",i="manual";if(t){const[p,e]=t;p&&m(e)&&(e.view=null,f(e)&&p.remove(e,o))}p&&m(e)&&(e.view=this,f(e)&&p.add(e,{key:o,position:i,internal:!0}))}),c),this.on("click",(p=>{this.popup&&this.popupEnabled&&("mouse"!==p.pointerType||0===p.button)&&(!m(this.popup)&&"autoOpenEnabled"in this.popup&&!1===this.popup.autoOpenEnabled||(m(this.popup)?this.popup.viewModel.handleViewClick(p):p.async((async()=>{await this.setupPopup(),m(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(p)}))))}),w.WIDGET)]),l((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{import("../widgets/Popup.js")}))}destroy(){this.destroyed||this.closePopup()}async openPopup(p){if(m(this.popup))return this.popup.open(p);try{if(await this.setupPopup(),!this.popup)return void i.getLogger(this).error(new o("view:null-popup","Popup is null and can't be opened"));this.popup.open(p)}catch{}}closePopup(){this._popupSetupTask?.abort(),m(this.popup)&&this.popup.close()}async fetchPopupFeatures(p,e){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(p,e),e)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!m(this.popup))return this._popupSetupTask=e((async p=>{const{default:e}=await import("../widgets/Popup.js");if(s(p),!this.popup||m(this.popup))return;const t=this.popup;delete t.open,delete t.close,this.popup=new e(t)})),this._popupSetupTask.promise}async _popupHitsToFeatures({location:p,hits:e},t){const o=[],i=[];let s=!1;const n=r(t,has("popup-view-fetch-timeout")??P),u=p=>{const e=new g(p);return i.push(e),o.push(e.promise),e},c=p=>{const e=i.at(-1);return e&&e.layerView===p&&!s?e:u(p)};for(const r of e)if("graphic"in r){c(r.layerView).graphics.push(r.graphic),s=!1}else o.push(r.layerView.fetchPopupFeaturesAtLocation(r.mapPoint,n)),s=!0;i.map((p=>p.resolve(n)));const l=a(o).then((p=>p.filter((p=>!!p)).flat()));return{pendingFeatures:o,allGraphicsPromise:l,location:p}}async _getPopupHits(p,e){const{hits:t,location:o}=await this.popupHitTest(p);s(e);const i=[];for(const s of t)if("graphic"in s){if(this._isValidPopupGraphic(s.graphic,e)){const p=this._isValidPopupGraphicsLayerView(s.layerView)?s.layerView:void 0;i.push({graphic:s.graphic,layerView:p})}}else this._isValidPopupLocationLayerView(s.layerView)&&i.push({mapPoint:s.mapPoint,layerView:s.layerView});return{hits:i,location:o}}_isValidPopupGraphic(p,e){return p&&!!p.getEffectivePopupTemplate(null!=e&&e.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(p){return!p||(!("layer"in p)||!p.suspended)&&"fetchPopupFeaturesFromGraphics"in p}_isValidPopupLocationLayerView(p){return(!("layer"in p)||!p.suspended)&&"fetchPopupFeaturesAtLocation"in p}};return p([h({cast(p){return!p||m(p)||"object"==typeof p&&(p.open=p=>(t(i.getLogger(this),"view.popup is no longer created by default. view.popup.open() will stop working when the popup isn't created",{replacement:"Use view.openPopup() instead.",version:"4.27"}),this.openPopup(p)),p.close=()=>(t(i.getLogger(this),"view.popup is no longer created by default. view.popup.close() will stop working when the popup isn't created",{replacement:"Use view.closePopup() instead.",version:"4.27"}),this.closePopup())),p}})],y.prototype,"popup",void 0),p([h()],y.prototype,"popupEnabled",void 0),y=p([d("esri.views.PopupView")],y),y};class g{constructor(p){this.layerView=p,this._resolver=n(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(p){const{layerView:e,graphics:t,_resolver:o}=this;if(!e)return o.resolve(t),o.promise;let i;return e.fetchPopupFeaturesFromGraphics(t,p).catch((p=>(i=p,null))).then((p=>{p?o.resolve(p):o.reject(i)})),o.promise}}const P=5e3;export{y as PopupView};
