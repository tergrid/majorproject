/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import"../../geometry.js";import{isSome as t}from"../../core/arrayUtils.js";import"../../core/has.js";import{clone as e}from"../../core/lang.js";import{clamp as n}from"../../core/mathUtils.js";import{createScreenPoint as r}from"../../core/screenUtils.js";import{fromValues as a,clone as o}from"../../core/libs/gl-matrix-2/factories/vec3f64.js";import{project as l}from"../../geometry/projection.js";import{isRelativeVertexSpace as c,vertexSpaceOriginToPoint as s}from"../../geometry/support/meshVertexSpaceUtils.js";import{hydratedSpatialReference as i,clonePoint as u}from"../../layers/graphics/hydratedFeatures.js";import{MeshTransformUpdateAction as p}from"../../layers/graphics/sources/interfaces.js";import{getZForElevationMode as m}from"../../support/elevationInfoUtils.js";import{move as f}from"../draw/support/drawUtils.js";import d from"../../geometry/Point.js";function y(t,e){let n=null,r=null;return a=>{if("cancel"===a.action)return void(null!=r&&(r.execute({action:"cancel"}),n=null,r=null));const o={action:a.action,screenStart:a.start,screenEnd:a.screenPoint};"start"===a.action&&null==n&&(n=new Y,r=new Y,e(t,n,r,a.pointerType,o)),null!=n&&n.execute(o),"end"===a.action&&null!=n&&(n=null,r=null)}}function x(t,e){return t.events.on("drag",y(t,e))}function h(t,e){const n=[t.x,t.y,t.z??0],r=e,a=[Math.cos(r),Math.sin(r)],o=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===o)return null;a[0]/=o,a[1]/=o;const l=t=>{const e=(t.x-n[0])*a[0]+(t.y-n[1])*a[1];t.x=n[0]+e*a[0],t.y=n[1]+e*a[1]};return t=>(l(t.mapStart),l(t.mapEnd),{...t,axis:a})}function S(t){let e=null;return n=>{if("start"===n.action&&(e=g(t,n.mapStart.spatialReference)),null==e)return null;const r=n.mapEnd.x-n.mapStart.x,a=n.mapEnd.y-n.mapStart.y,o=n.mapEnd.z-n.mapStart.z;return e.move(r,a,o,n.action),{...n,translationX:r,translationY:a,translationZ:o}}}function E(t,e){return null==t?null:t.spatialReference.equals(e)?t.clone():l(t,e)}function g(t,e){const n=t.geometry,r=i(e);if(null==n)return null;if("mesh"===n.type)return v(t,n,r);const a=E(n,r),o=n.spatialReference;return null==a?null:{move:(e,n,r)=>{const c=f(a.clone(),e,n,r);c.spatialReference.equals(o)?t.geometry=c:t.geometry=l(c,o)}}}function v(t,e,n){if(c(e.vertexSpace))return z(t,e,e.vertexSpace,n);if(!e.spatialReference.equals(n))return null;let r=0,a=0,o=0;return{move:(n,l,c)=>{const s=n-r,i=l-a,u=c-o;if(s||i||u){const p=new d(e.anchor.x+s,e.anchor.y+i,(e.anchor.z??0)+u,e.anchor.spatialReference);e.centerAt(p),t.notifyGeometryChanged(),r=n,a=l,o=c}}}}function z(t,e,n,r){const o=E(s(e.vertexSpace,e.spatialReference),r),c=e.spatialReference;return null==o?null:{move:(e,r,s,i)=>{const u=f(o.clone(),e,r,s);if(u.spatialReference.equals(c))n.origin=a(u.x,u.y,u.z??0);else{const t=l(u,c);null!=t&&(n.origin=a(t.x,t.y,t.z??0))}const m="end"===i;t.notifyMeshTransformChanged(m?{action:p.UpdateFastLocalOrigin}:{})}}}function j(t,e=null,n){let r=null;const a=null==e||t.spatialReference?.equals(e)?t=>t:t=>null!=t?l(t,e):t,o={exclude:[],...n};return e=>{if("start"===e.action&&(r=a(t.toMap(e.screenStart,o))),null==r)return null;const n=a(t.toMap(e.screenEnd,o));return null!=n?{...e,mapStart:r,mapEnd:n}:null}}function R(e){const n=e.map((t=>S(t))).filter(t);return t=>{const e=t.mapEnd.x-t.mapStart.x,r=t.mapEnd.y-t.mapStart.y,a=t.mapEnd.z-t.mapStart.z;return n.forEach((e=>e(t))),{...t,translationX:e,translationY:r,translationZ:a}}}function M(t,n){const r=new Map;for(const a of n)r.set(a,e(t[a]));return e=>(r.forEach(((e,n)=>{t[n]=e})),e)}function w(t){return null!=t.geometry&&"mesh"===t.geometry.type?U(t,t.geometry):M(t,["geometry"])}function U(t,e){const{vertexSpace:n}=e;if("georeferenced"===n.type){const n=e.vertexAttributes.clonePositional();return r=>(e.vertexAttributes=n,t.notifyGeometryChanged(),r)}const r=o(n.origin),a=e.transform?.clone();return n=>(e.transform=a,e.vertexSpace.origin=r,t.notifyMeshTransformChanged(),n)}function q(t){const e=t.map((t=>w(t))).filter((t=>null!=t));return t=>(e.forEach((e=>e(t))),t)}function D(){let t=0,e=0,n=0;return r=>{"start"===r.action&&(t=r.mapStart.x,e=r.mapStart.y,n=r.mapStart.z);const a=r.mapEnd.x-t,o=r.mapEnd.y-e,l=r.mapEnd.z-n;return t=r.mapEnd.x,e=r.mapEnd.y,n=r.mapEnd.z,{...r,mapDeltaX:a,mapDeltaY:o,mapDeltaZ:l,mapDeltaSpatialReference:r.mapStart.spatialReference}}}function P(){let t=0,e=0;return n=>{"start"===n.action&&(t=n.screenStart.x,e=n.screenStart.y);const r=n.screenEnd.x-t,a=n.screenEnd.y-e;return t=n.screenEnd.x,e=n.screenEnd.y,{...n,screenDeltaX:r,screenDeltaY:a}}}function C(t,e){let a=null,o=0,l=0;return c=>{if("start"===c.action&&(a=t.toScreen?.(e),null!=a&&(a.x<0||a.x>t.width||a.y<0||a.y>t.height?a=null:(o=c.screenStart.x-a.x,l=c.screenStart.y-a.y))),null==a)return null;const s=n(c.screenEnd.x-o,0,t.width),i=n(c.screenEnd.y-l,0,t.height),u=r(s,i);return c.screenStart=a,c.screenEnd=u,c}}const X=()=>{};class Y{constructor(){this.execute=X}next(t,e=new Y){return null!=t&&(this.execute=n=>{const r=t(n);null!=r&&e.execute(r)}),e}}function Z(t,e,n=[]){if("2d"===t.type)return t=>t;let r=null;return a=>{"start"===a.action&&(r=t.toMap(a.screenStart,{exclude:n}),null!=r&&(r.z=m(r,t,e)));const o=t.toMap(a.screenEnd,{exclude:n});null!=o&&(o.z=m(o,t,e));const l=null!=r&&null!=o?{sceneStart:r,sceneEnd:o}:null;return{...a,scenePoints:l}}}function b(t,e,n){const r=e.elevationProvider.getElevation(t.x,t.y,t.z??0,t.spatialReference,"scene")??0,a=u(t);return a.z=r,a.hasZ=!0,a.z=m(a,e,n),a}function A(t,e){if("2d"===t.type)return t=>t;let n=null;return r=>{"start"===r.action&&(n=b(r.mapStart,t,e));const a=b(r.mapEnd,t,e),o=null!=n&&null!=a?{sceneStart:n,sceneEnd:a}:null;return{...r,scenePoints:o}}}export{Y as EventPipeline,D as addMapDelta,P as addScreenDelta,h as constrainToMapAxis,y as createDragEventPipelineCallback,x as createManipulatorDragEventPipeline,C as dragAtLocation,S as dragGraphic,R as dragGraphicMany,w as resetGraphic,q as resetGraphicMany,M as resetProperties,Z as sceneSnappingAtLocation,A as sceneSnappingAtProjectedLocation,j as screenToMap};
