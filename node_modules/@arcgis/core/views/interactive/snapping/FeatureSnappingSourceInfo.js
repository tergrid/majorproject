/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import r from"../../../core/Accessor.js";import t from"../../../core/Logger.js";import{watch as i,syncAndInitial as l}from"../../../core/reactiveUtils.js";import{sqlAnd as s}from"../../../core/sql.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/RandomLCG.js";import{subclass as a}from"../../../core/accessorSupport/decorators/subclass.js";import n from"../../../layers/support/FeatureFilter.js";import{getFloorFilterClause as p}from"../../../layers/support/floorFilterUtils.js";import{isSubtypeGroupLayer as u,isFeatureLayer as y}from"../../../layers/support/layerUtils.js";import{isUtilityNetworkWebMap as c}from"./snappingUtils.js";import{scaleBoundsPredicate as d}from"../../support/layerViewUtils.js";let f=class extends r{get layerView(){return this.view?.allLayerViews?.find((e=>e.layer===this.layer))}get valid(){return this._valid}get subtypeFilter(){const{layer:e,snappingSource:r}=this;if(!u(e)||!e.subtypes?.length)return{mode:"not-in-use",filter:null};const t=r.layerSource.sublayerSources.filter((e=>e.enabled&&e.layer.visible&&d(this.view?.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale))).map((e=>e.layer.subtypeCode));if(!t.length)return{mode:"none-visible",filter:null};if(t.length===e.subtypes.length)return{mode:"all-visible",filter:null};const i=e.fieldsIndex.get(e.subtypeField)?.name??e.subtypeField;return 1===t.length?{mode:"in-use",filter:`${i} = ${t.getItemAt(0)}`}:{mode:"in-use",filter:`${i} IN (${t.join(", ")})`}}get floorFilter(){const{view:e,layer:r}=this;return e&&r?p({view:e,layer:r}):null}constructor(e){super(e),this.rulesTable=null,this._valid=!1}initialize(){if(!this.snappingSource||!this.layer)return;const{layer:e,snappingSource:r}=this;if("refresh"in e){const t=e;this.addHandles(t.on("refresh",(()=>r.refresh())))}this.loadRules(),this.addHandles([i((()=>r.updating),(e=>r.layerSource.updating=e),l),i((()=>r.availability),(e=>r.layerSource.availability=e),l)])}getFetchCandidatesParameters(e,r,t){if(!this.valid)return[];const{layer:i,layerView:l,floorFilter:o,rulesTable:a,subtypeFilter:p}=this,d={distance:t,mode:this.view?.type??"2d",point:e,coordinateHelper:r.coordinateHelper,...this._types,filter:l&&"filter"in l?l.filter:null};if(o&&(d.filter=h(d.filter,o)),"not-in-use"!==p.mode&&"all-visible"!==p.mode){if("none-visible"===p.mode)return[];d.filter?d.filter.where=s(d.filter.where,p.mode):d.filter=new n({where:p.filter})}const f=r.feature,m="subtype-sublayer"===f?.sourceLayer?.type?f.sourceLayer.parent:f?.sourceLayer;if(a&&f&&c(this.view?.map)&&(y(i)||u(i))&&i.layerId&&(y(m)||u(m))&&this.view.map.utilityNetworks?.find((e=>e.isUtilityLayer(m)))){if("loaded"!==a.loadStatus)return[];const e=[],r=i.layerId,t=a.getFeatureSQL(m,f)?.[r];if(!t)return[];const l=t.anyVertex;let s=t.endVertex;return s&&l&&s===l&&(s=""),s&&e.push({...d,returnEdge:!1,vertexMode:"ends",filter:h(d.filter,s)}),l&&e.push({...d,returnEdge:!1,vertexMode:"all",filter:h(d.filter,l)}),e}return[d]}async loadRules(){const{layer:e,view:r}=this;if(e&&r&&c(r?.map)&&(y(e)||u(e))){const l=r.map.utilityNetworks?.find((r=>r.isUtilityLayer(e)));if(l)try{this.rulesTable=await l.getRulesTable(),await(this.rulesTable?.load())}catch(i){return void t.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}}this._valid=!0}get _types(){return{returnEdge:!0,vertexMode:"all"}}remove(){this.destroy()}destroy(){this.snappingSource?.destroy()}};function h(e,r){return null==e?new n({where:r}):e.where?new n({where:s(e.where,r)}):new n({where:r})}e([o({constructOnly:!0})],f.prototype,"layer",void 0),e([o({constructOnly:!0})],f.prototype,"snappingSource",void 0),e([o({constructOnly:!0})],f.prototype,"view",void 0),e([o()],f.prototype,"layerView",null),e([o()],f.prototype,"rulesTable",void 0),e([o()],f.prototype,"valid",null),e([o()],f.prototype,"subtypeFilter",null),e([o()],f.prototype,"floorFilter",null),e([o()],f.prototype,"_valid",void 0),f=e([a("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],f);export{f as FeatureSnappingSourceInfo};
