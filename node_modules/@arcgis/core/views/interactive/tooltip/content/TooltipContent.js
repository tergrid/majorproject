/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import"../../../../intl.js";import{prefersReducedMotion as e}from"../../../../core/a11yUtils.js";import{memoize as i}from"../../../../core/memoize.js";import{throwIfNotAbortError as o,throwIfAborted as s,after as n}from"../../../../core/promiseUtils.js";import{formatAngle as r,formatArea as a,formatLength as l,formatRelativeLength as c,formatVerticalLength as p,formatRelativeVerticalLength as m}from"../../../../core/quantityFormatUtils.js";import{waitTick as u}from"../../../../core/scheduling.js";import{unitName as d}from"../../../../core/unitFormatUtils.js";import{defaultLengthUnit as h,defaultVerticalLengthUnit as g,defaultAreaUnit as f}from"../../../../core/unitUtils.js";import{property as _}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as y}from"../../../../core/accessorSupport/decorators/subclass.js";import{getDefaultUnitForView as v}from"../../../../support/getDefaultUnitForView.js";import{tooltipKeys as b}from"../../keybindings.js";import{helpMessage as w,table as j,contentHeader as F,contentHeaderSpacer as x,contentHeaderActions as U,contentInputMode as k,content as D,drawContentHeaderActions as A}from"../css.js";import{getDegreesGeographic as T}from"../../../support/angularMeasurementUtils.js";import C from"../../../../widgets/Widget.js";import{loadCalciteComponents as I}from"../../../../widgets/support/componentsUtils.js";import{classes as M}from"../../../../widgets/support/widgetUtils.js";import{messageBundle as R}from"../../../../widgets/support/decorators/messageBundle.js";import{tsx as L,tsxFragment as E}from"../../../../widgets/support/jsxFactory.js";import{formatNumber as S}from"../../../../intl/number.js";let q=class extends C{constructor(){super(...arguments),this._focusAbortController=new AbortController,this._transition=null,this._mode="feedback",this._getFormatters=i(((t,e)=>({angleRelative:t=>S(t,{minimumFractionDigits:V,maximumFractionDigits:V,signDisplay:"exceptZero"}),direction:t=>r(t,t.rotationType,V),directionRelative:t=>{const e=T(t);return S(e,{style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:V,minimumFractionDigits:V,signDisplay:e>0?"never":"exceptZero"})},directionRelativeBilateral:t=>r(t,t.rotationType,V),area:(i,o)=>a(t,i,o??e.area),length:(i,o,s)=>l(t,i,o??e.length,s),lengthRelative:(i,o)=>c(t,i,o??e.length),totalLength:(i,o)=>l(t,i,o??e.length),verticalLength:(i,o)=>p(t,i,o??e.length),verticalLengthRelative:(i,o)=>m(t,i,o??e.verticalLength),percentage:t=>S(t.value,{style:"percent"}),scale:t=>S(t,{style:"percent",maximumFractionDigits:0})}))),this._onDiscard=()=>{this.exitInputMode()},this._onCommit=(t,e)=>{if("commit-and-exit"===e)return void this.exitInputMode();const i=this._getFocusableElements(),o=i.length,s=i.indexOf(t);if(-1===s)return void this.exitInputMode();const n=((s+("commit-and-next"===e?1:-1))%o+o)%o;N(i.at(n))},this._handleTab=t=>{if(t.code!==b.next)return;const e=this._getFocusableElements(),i=e.at(0),o=e.at(-1);i&&o&&(t.shiftKey?document.activeElement===i&&(t.preventDefault(),N(o)):document.activeElement===o&&(t.preventDefault(),N(i)))}}get mode(){return this._mode}get _displayUnits(){const t=v(this.tooltip.view);return{length:t,verticalLength:t,area:t,angle:"degrees"}}get _inputUnitInfos(){const t=this._messagesUnits,e=e=>({unit:e,abbreviation:d(t,e,"abbr")}),i=v(this.tooltip.view),o=e(h(i)),s=e(g(i)),n=e(f(i)),r=e("degrees");return{length:o,lengthRelative:o,verticalLength:s,verticalLengthRelative:s,area:n,direction:r,orientation:r,rotation:r}}get _formatters(){return this._getFormatters(this._messagesUnits,this._displayUnits)}get fieldContext(){return{formatters:this._formatters,inputUnitInfos:this._inputUnitInfos,messages:this._messagesTooltip,sketchOptions:this.info.sketchOptions,onCommit:this._onCommit,onDiscard:this._onDiscard}}render(){const t=O(this._renderContent()),{visibleElements:e}=this.info.sketchOptions.tooltips,i=e.helpMessage?this._getHelpMessage():null,o=t.length>0,s=o||!!i,n="input"===this.mode,r=O(this._renderActions());return L("div",{class:M(D,n&&k),onkeydown:this._handleTab},n&&s&&e.header?L("div",{class:F,key:"header"},L("calcite-button",{appearance:"transparent",iconFlipRtl:"both",iconStart:"chevron-left",key:"discard-button",kind:"neutral",onclick:this._onDiscard,scale:"s",tabIndex:-1}),r.length>0?L(E,null,L("div",{class:x,key:"spacer"}),L("div",{class:U,key:"actions"},r)):null):null,o?L("div",{class:j,key:"content"},...t):null,i?L("div",{class:w,key:"help-message"},i):null)}_renderActions(){return null}loadDependencies(){return I({button:()=>import("@esri/calcite-components/dist/components/calcite-button.js"),icon:()=>import("@esri/calcite-components/dist/components/calcite-icon.js"),input:()=>import("@esri/calcite-components/dist/components/calcite-input.js")})}async enterInputMode(t){try{await this._transitionTo("input"),await this._focusField(t)}catch(e){o(e)}}async exitInputMode(){try{await this._transitionTo("feedback"),document.querySelector(".esri-view-surface").focus()}catch(t){o(t)}}_getHelpMessage(t){const{info:e}=this,{helpMessage:i,viewType:o}=e,s=t??i,n="3d"===o?"helpMessages3d":"helpMessages2d";return s?this._messagesTooltip?.sketch?.[n]?.[s]:void 0}async _focusField(t){this._focusAbortController?.abort(),this._focusAbortController=new AbortController;const{signal:e}=this._focusAbortController;await this._waitForInputs(),s(e);const i=this._getFocusableInputs();N(t?i.find((e=>e.getAttribute("data-field-name")===t)):i.at(0))}async _transitionTo(t){if(this._mode===t)return;const i=()=>{this._mode=t,this.tooltip.positionMode="input"===t?"fixed":"follow-cursor"};if(!this.domNode?.firstChild||!document.startViewTransition||e())return void i();this.autoRenderingEnabled=!1,this._transition?.skipTransition();const o=this._transition=document.startViewTransition((()=>{if(!this.destroyed)return this.autoRenderingEnabled=!0,i(),this.renderNow(),u()}));try{await this._transition.finished}finally{o===this._transition&&(this._transition=null)}}async _waitForInputs(){const t=Date.now(),e=()=>Array.from(this.domNode?.querySelectorAll("calcite-input")??[]);for(;0===e().length;)if(await n(B),Date.now()-t>H)return}_getFocusableInputs(){return Array.from(this.domNode?.querySelectorAll("calcite-input:not([read-only]):not([disabled])")??[])}_getFocusableElements(){const t=this.domNode?.querySelector(`.${A}`);return[...Array.from(t?.querySelectorAll("calcite-action:not([disabled])")??[]),...this._getFocusableInputs()]}};function N(t){t?.setFocus()}function O(t){return(Array.isArray(t)?t:[t]).flat(10).filter((t=>!!t))}t([R("esri/core/t9n/Units"),_()],q.prototype,"_messagesUnits",void 0),t([R("esri/views/interactive/tooltip/t9n/Tooltip"),_()],q.prototype,"_messagesTooltip",void 0),t([_()],q.prototype,"info",void 0),t([_()],q.prototype,"tooltip",void 0),t([_()],q.prototype,"_mode",void 0),t([_()],q.prototype,"mode",null),t([_()],q.prototype,"_displayUnits",null),t([_()],q.prototype,"_inputUnitInfos",null),t([_()],q.prototype,"_formatters",null),t([_()],q.prototype,"fieldContext",null),q=t([y("esri.views.interactive.tooltip.content.TooltipContent")],q);const V=1,B=50,H=1e3;export{q as TooltipContent};
